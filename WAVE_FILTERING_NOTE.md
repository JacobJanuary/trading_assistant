# Фильтрация по волнам - статус реализации

## Что такое фильтрация по волнам?

Из эталонного файла `check_wr_final.py`:
- Сигналы группируются по 15-минутным интервалам ("волнам")
- Внутри каждой волны сигналы сортируются по score_week
- Волны обрабатываются последовательно по времени
- Учитывается доступный капитал и открытые позиции

## Текущая реализация

❌ **НЕ РЕАЛИЗОВАНО** - требует полной переработки архитектуры

### Почему не реализовано?

Полная реализация требует:
1. **Управление капиталом** (~200 строк кода):
   - initial_capital, available_capital
   - Резервирование маржи при открытии позиции
   - Освобождение капитала при закрытии
   - Расчет min_equity

2. **Отслеживание позиций** (~100 строк):
   - Словарь открытых позиций
   - Проверка дубликатов по паре
   - Закрытие позиций между волнами

3. **Floating PnL** (~50 строк):
   - Расчет unrealized PnL для открытых позиций
   - Обновление equity на каждой волне

4. **Изменение архитектуры** (~200 строк):
   - Переход с последовательной обработки на волновую
   - Группировка сигналов: `signals_by_wave`
   - Сортировка внутри волн
   - Обработка волн по времени

**Итого:** ~550+ строк нового кода, полная переработка `process_scoring_signals_batch()`

## Что УЖЕ исправлено (критичные проблемы)

✅ **Таймфрейм 5m** вместо 15m - более точное отслеживание цен
✅ **3-фазная торговая система** - Phase 1 (TS/SL), Phase 2 (Breakeven), Phase 3 (Smart Loss)
✅ **Проверка ликвидации** - предотвращение margin call
✅ **Учет комиссий** - все PnL рассчитываются NET

## Влияние отсутствия фильтрации по волнам

### В эталонном файле:
```python
max_trades_per_wave = 3  # Максимум 3 сделки за волну
available_capital = 1000  # Отслеживание капитала
```

### Текущая реализация:
- Обрабатывает ВСЕ сигналы подряд
- Не учитывает доступный капитал
- Не группирует по волнам
- Не проверяет дубликаты по паре

### Оценка влияния:
- **Win Rate:** Завышен на ~5-10% (открывает больше сделок, чем возможно реально)
- **Total PnL:** Завышен в ~1.5-2x (учитывает сделки без доступного капитала)
- **Trades Count:** Завышен в ~2-3x (нет ограничения на одновременные позиции)

## Рекомендации

### ✅ СДЕЛАНО (приоритет КРИТИЧНЫЙ):
1. Таймфрейм 5m
2. 3-фазная система
3. Ликвидация
4. Комиссии

### ❌ НЕ СДЕЛАНО (приоритет СРЕДНИЙ):
5. Фильтрация по волнам + управление капиталом

**Причина:** Требует полной переработки архитектуры (~550+ строк кода)

**Решение:**
- Оставить как есть для текущей версии
- Запланировать на будущий рефакторинг
- Пользователи должны понимать, что результаты Scoring Analysis оптимистичны

## Для будущей реализации

См. эталонный файл `/home/elcrypto/calk_wk/check_wr_final.py`:
- Строки 403-486: Полная реализация wave-based filtering
- Строки 412-459: Capital management
- Строки 448-449: Floating PnL calculation
