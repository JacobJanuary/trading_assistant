{% extends "base.html" %}

{% block title %}Whale Futures Tracker{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">
        <i class="fas fa-fish mr-3 text-blue-600"></i>
        Whale Futures Tracker
    </h1>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-sm text-gray-600">Total Positions</div>
            <div id="stat-total" class="text-2xl font-bold text-gray-900">-</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-sm text-gray-600">LONG Positions</div>
            <div id="stat-long" class="text-2xl font-bold text-green-600">-</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-sm text-gray-600">SHORT Positions</div>
            <div id="stat-short" class="text-2xl font-bold text-red-600">-</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="text-sm text-gray-600">Total Volume</div>
            <div id="stat-volume" class="text-2xl font-bold text-blue-600">-</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Time Filter</label>
                <select id="time-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <option value="24h" selected>Last 24h</option>
                    <option value="12h">Last 12h</option>
                    <option value="6h">Last 6h</option>
                    <option value="1h">Last 1h</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Min Size USD</label>
                <input type="number" id="min-size" value="10000000" class="w-full px-3 py-2 border border-gray-300 rounded-md">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Side</label>
                <select id="side-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <option value="both" selected>Both</option>
                    <option value="LONG">LONG</option>
                    <option value="SHORT">SHORT</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Exchange</label>
                <select id="exchange-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <option value="all" selected>All</option>
                    <option value="Binance">Binance</option>
                    <option value="Hyperliquid">Hyperliquid</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Whale Positions Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Time</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Exchange</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Symbol</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Side</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Size USD</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Price</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">MM</th>
                </tr>
            </thead>
            <tbody id="whale-table" class="bg-white divide-y divide-gray-200">
                <tr>
                    <td colspan="7" class="px-4 py-8 text-center text-gray-500">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
let refreshInterval;

function formatNumber(num) {
    if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
    if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
    if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
    return num.toFixed(2);
}

function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
}

async function loadData() {
    const timeFilter = document.getElementById('time-filter').value;
    const minSize = document.getElementById('min-size').value;
    const side = document.getElementById('side-filter').value;
    const exchange = document.getElementById('exchange-filter').value;

    try {
        // Load stats
        const statsResp = await fetch(`/api/whale_futures/stats?time_filter=${timeFilter}&min_size_usd=${minSize}`);
        const statsData = await statsResp.json();

        if (statsData.status === 'success' && statsData.stats) {
            document.getElementById('stat-total').textContent = statsData.stats.total_positions;
            document.getElementById('stat-long').textContent = statsData.stats.long_count;
            document.getElementById('stat-short').textContent = statsData.stats.short_count;
            document.getElementById('stat-volume').textContent = '$' + formatNumber(statsData.stats.total_volume_usd);
        }

        // Load positions
        const dataResp = await fetch(`/api/whale_futures/data?time_filter=${timeFilter}&min_size_usd=${minSize}&side=${side}&exchange=${exchange}&limit=100`);
        const posData = await dataResp.json();

        const tbody = document.getElementById('whale-table');

        if (posData.status === 'success' && posData.data && posData.data.length > 0) {
            tbody.innerHTML = posData.data.map(pos => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm text-gray-900">${formatTime(pos.trade_timestamp)}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${pos.exchange}</td>
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${pos.symbol}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 rounded text-xs font-semibold ${pos.side === 'LONG' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${pos.side}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-right font-semibold text-gray-900">$${formatNumber(pos.size_usd)}</td>
                    <td class="px-4 py-3 text-sm text-right text-gray-600">${pos.price ? '$' + pos.price.toFixed(2) : '-'}</td>
                    <td class="px-4 py-3 text-sm text-center">
                        ${pos.is_market_maker ? '<i class="fas fa-check text-yellow-600"></i>' : ''}
                    </td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">No data found</td></tr>';
        }
    } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('whale-table').innerHTML =
            '<tr><td colspan="7" class="px-4 py-8 text-center text-red-500">Error loading data</td></tr>';
    }
}

// Event listeners
document.getElementById('time-filter').addEventListener('change', loadData);
document.getElementById('min-size').addEventListener('change', loadData);
document.getElementById('side-filter').addEventListener('change', loadData);
document.getElementById('exchange-filter').addEventListener('change', loadData);

// Initial load and auto-refresh
loadData();
refreshInterval = setInterval(loadData, 60000); // Refresh every 60 seconds
</script>
{% endblock %}
