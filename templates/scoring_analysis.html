{% extends "base.html" %}

{% block title %}Анализ скоринга - Помощник Трейдера{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <h1 class="text-2xl font-bold text-gray-800 mb-6">
        <i class="fas fa-chart-area mr-2 text-blue-600"></i>
        Анализ скоринга
    </h1>

    <!-- Фильтр даты с информацией о рынке -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-filter mr-2 text-blue-600"></i>
            Параметры фильтрации
        </h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Левая колонка: Дата и фильтры скоринга -->
            <div class="space-y-4">
                <!-- Выбор даты -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Дата анализа</label>
                    <input type="date" id="dateFilter"
                           value="{{ selected_date }}"
                           min="{{ date_range.min_date }}"
                           max="{{ date_range.max_date }}"
                           onchange="updateDateInfo()"
                           class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    <span class="text-xs text-gray-600 mt-1 block">
                        Доступно: {{ date_range.min_date }} — {{ date_range.max_date }}
                    </span>
                </div>

                <!-- Фильтр Score Week -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Минимальный Score Week
                        <span id="scoreWeekValue" class="text-blue-600 font-semibold ml-2">0</span>
                    </label>
                    <div class="flex items-center space-x-3">
                        <span class="text-sm text-gray-500">-100</span>
                        <input type="range" id="scoreWeekFilter"
                               min="-100" max="100" step="1" value="0"
                               oninput="updateScoreDisplay('week', this.value)"
                               class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <span class="text-sm text-gray-500">100</span>
                    </div>
                </div>

                <!-- Фильтр Score Month -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Минимальный Score Month
                        <span id="scoreMonthValue" class="text-blue-600 font-semibold ml-2">0</span>
                    </label>
                    <div class="flex items-center space-x-3">
                        <span class="text-sm text-gray-500">-100</span>
                        <input type="range" id="scoreMonthFilter"
                               min="-100" max="100" step="1" value="0"
                               oninput="updateScoreDisplay('month', this.value)"
                               class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <span class="text-sm text-gray-500">100</span>
                    </div>
                </div>
            </div>

            <!-- Правая колонка: Информация о рынке и результатах -->
            <div class="space-y-4">
                <!-- Информация о режимах рынка -->
                <div id="marketInfo" class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3">Режимы рынка в выбранный день</h3>
                    <div id="marketRegimes" class="grid grid-cols-3 gap-2 mb-3">
                        <!-- Заполняется через JS -->
                    </div>
                    <div id="dominantRegime" class="text-sm text-gray-600">
                        <!-- Заполняется через JS -->
                    </div>
                </div>

                <!-- Превью результатов -->
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">Предварительный подсчет</h3>
                    <div id="previewStats" class="text-sm text-gray-600">
                        <div>Сигналов найдено: <span id="previewCount" class="font-bold text-blue-600">0</span></div>
                        <div class="text-xs text-gray-500 mt-1">Нажмите "Применить фильтры" для детального анализа</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Панель управления и параметры расчета -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-cog mr-2 text-blue-600"></i>
            Параметры торговли
        </h2>

        <div class="grid grid-cols-2 md:grid-cols-2 gap-4 mb-4">
            <!-- Параметры расчета из сохраненной стратегии -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Позиция ($)</label>
                <input type="number" id="positionSize" value="{{ params.position_size }}"
                       min="10" max="1000" step="10"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Leverage</label>
                <input type="number" id="leverage" value="{{ params.leverage }}"
                       min="1" max="20" step="1"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md">
            </div>
        </div>
        
        <!-- Фильтр по часам -->
        <div class="bg-yellow-50 p-3 rounded-lg mb-4">
            <div class="text-xs text-gray-600 mb-1">Фильтр по часам (UTC)</div>
            <div class="text-sm font-semibold text-gray-800" id="hoursFilter">
                {% if allowed_hours %}
                    {% if allowed_hours|length == 24 %}
                        Все часы (0-23)
                    {% elif allowed_hours|length == 0 %}
                        Нет выбранных часов
                    {% else %}
                        Часы: 
                        {% set ns = namespace(ranges=[]) %}
                        {% set ns.start = allowed_hours[0] %}
                        {% set ns.end = allowed_hours[0] %}
                        {% for hour in allowed_hours[1:] %}
                            {% if hour == ns.end + 1 %}
                                {% set ns.end = hour %}
                            {% else %}
                                {% if ns.start == ns.end %}
                                    {% set _ = ns.ranges.append(ns.start|string) %}
                                {% else %}
                                    {% set _ = ns.ranges.append(ns.start|string + '-' + ns.end|string) %}
                                {% endif %}
                                {% set ns.start = hour %}
                                {% set ns.end = hour %}
                            {% endif %}
                        {% endfor %}
                        {% if ns.start == ns.end %}
                            {% set _ = ns.ranges.append(ns.start|string) %}
                        {% else %}
                            {% set _ = ns.ranges.append(ns.start|string + '-' + ns.end|string) %}
                        {% endif %}
                        {{ ns.ranges|join(', ') }}
                    {% endif %}
                {% else %}
                    Все часы (по умолчанию)
                {% endif %}
            </div>
            <div class="text-xs text-gray-500 mt-1">
                <a href="{{ url_for('signal_performance') }}" class="text-blue-600 hover:text-blue-700 underline">
                    Настроить в разделе Сигналы
                </a>
            </div>
        </div>
        
        <!-- Параметры стратегии из сохраненных настроек -->
        <div class="bg-gray-50 p-3 rounded-lg mb-4">
            <div class="text-xs text-gray-600 mb-2">Параметры стратегии (из сохраненных настроек):</div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div>
                    <span class="text-gray-600">Режим:</span>
                    <span id="strategyMode" class="font-medium text-gray-800">{{ params.mode|default('Fixed') }}</span>
                </div>
                <div id="tpParam" style="display: {{ 'none' if params.mode == 'Trailing' else 'block' }};">
                    <span class="text-gray-600">TP:</span>
                    <span class="font-medium text-green-600">{{ params.tp_percent|default(2.0) }}%</span>
                </div>
                <div id="slParam">
                    <span class="text-gray-600">SL:</span>
                    <span class="font-medium text-red-600">{{ params.sl_percent|default(1.0) }}%</span>
                </div>
                <div id="trailingParams" style="display: {{ 'block' if params.mode == 'Trailing' else 'none' }};">
                    <span class="text-gray-600">Trailing:</span>
                    <span class="font-medium text-blue-600">{{ params.trailing_distance|default(2.0) }}% / {{ params.trailing_activation|default(1.0) }}%</span>
                </div>
            </div>
        </div>

        <!-- Режим стратегии и кнопки действий -->
        <div class="flex flex-wrap items-center justify-between gap-4 pt-4 border-t">
            <div class="flex items-center space-x-4">
                <span class="text-sm font-medium text-gray-700">Режим стратегии:</span>
                <span id="currentMode" class="px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                    <!-- Заполнится через JS -->
                </span>
                <button onclick="switchTradingMode()"
                        class="text-blue-600 hover:text-blue-700 text-sm underline">
                    Изменить в настройках сигналов
                </button>
            </div>

            <!-- Кнопки действий -->
            <div class="flex space-x-3">
                <button onclick="applyFilters()"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-colors">
                    <i class="fas fa-play mr-2"></i>
                    Применить фильтры
                </button>
                <button onclick="saveCurrentFilters()"
                        class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md transition-colors">
                    <i class="fas fa-save mr-2"></i>
                    Сохранить настройки
                </button>
            </div>
        </div>

        <!-- Сохраненные фильтры -->
        {% if saved_filters %}
        <div class="mt-4 pt-4 border-t">
            <label class="block text-sm font-medium text-gray-700 mb-2">Загрузить сохраненные:</label>
            <select id="savedFilters" onchange="loadSavedFilter()"
                    class="px-3 py-2 border border-gray-300 rounded-md">
                <option value="">Выберите...</option>
                {% for filter in saved_filters %}
                <option value="{{ loop.index0 }}">{{ filter.name }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
    </div>

    <!-- Статистика -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6" id="statsContainer" style="display: none;">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-chart-bar mr-2 text-blue-600"></i>
            Статистика эффективности стратегии
        </h2>

        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
            <div class="bg-blue-50 p-3 rounded-lg">
                <div class="text-xs text-gray-600">Всего сигналов</div>
                <div class="text-xl font-bold text-blue-600" id="statTotal">0</div>
            </div>
            <div class="bg-green-50 p-3 rounded-lg">
                <div class="text-xs text-gray-600">BUY</div>
                <div class="text-xl font-bold text-green-600" id="statBuy">0</div>
            </div>
            <div class="bg-red-50 p-3 rounded-lg">
                <div class="text-xs text-gray-600">SELL</div>
                <div class="text-xl font-bold text-red-600" id="statSell">0</div>
            </div>
            <div class="bg-emerald-50 p-3 rounded-lg">
                <div class="text-xs text-gray-600">Take Profit</div>
                <div class="text-xl font-bold text-emerald-600" id="statTP">0</div>
            </div>
            <div class="bg-rose-50 p-3 rounded-lg">
                <div class="text-xs text-gray-600">Stop Loss</div>
                <div class="text-xl font-bold text-rose-600" id="statSL">0</div>
            </div>
            <div class="bg-orange-50 p-3 rounded-lg">
                <div class="text-xs text-gray-600">Timeout (48ч)</div>
                <div class="text-xl font-bold text-orange-600" id="statTimeout">0</div>
            </div>
            <div class="bg-green-50 p-3 rounded-lg" id="pnlContainer">
                <div class="text-xs text-gray-600">P&L</div>
                <div class="text-xl font-bold text-green-600" id="statPnL">$0.00</div>
            </div>
        </div>

        <!-- Дополнительные метрики -->
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">
            <div class="bg-purple-50 p-3 rounded-lg">
                <div class="text-xs text-gray-600">Win Rate</div>
                <div class="text-lg font-bold text-purple-600" id="statWinRate">0.0%</div>
            </div>
            <div class="bg-indigo-50 p-3 rounded-lg">
                <div class="text-xs text-gray-600">Эффективность TP</div>
                <div class="text-lg font-bold text-indigo-600" id="statEfficiency">0.0%</div>
            </div>
            <div class="bg-yellow-50 p-3 rounded-lg">
                <div class="text-xs text-gray-600">Макс. потенциал</div>
                <div class="text-lg font-bold text-yellow-600" id="statMaxPotential">$0.00</div>
            </div>
        </div>
        <!-- Trailing Stop метрики -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
            <div class="bg-teal-50 p-3 rounded-lg">
                <div class="text-xs text-gray-600">Trailing Stop</div>
                <div class="text-lg font-bold text-teal-600" id="statTrailing">0</div>
            </div>
            <div class="bg-cyan-50 p-3 rounded-lg">
                <div class="text-xs text-gray-600">Trailing прибыльных</div>
                <div class="text-lg font-bold text-cyan-600" id="statTrailingWin">0</div>
            </div>
            <div class="bg-sky-50 p-3 rounded-lg">
                <div class="text-xs text-gray-600">Trailing убыточных</div>
                <div class="text-lg font-bold text-sky-600" id="statTrailingLoss">0</div>
            </div>
            <div class="bg-blue-50 p-3 rounded-lg">
                <div class="text-xs text-gray-600">Trailing эффективность</div>
                <div class="text-lg font-bold text-blue-600" id="statTrailingEff">0.0%</div>
            </div>
        </div>
    </div>

    <!-- Таблица сигналов -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden" id="signalsContainer" style="display: none;">
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <h2 class="text-lg font-semibold text-gray-800">
                <i class="fas fa-list mr-2 text-blue-600"></i>
                Сигналы
            </h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Время / Биржа
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Пара
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Сигнал
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Scores
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Вход
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Текущая
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        P&L
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Макс. профит
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Статус
                    </th>
                </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="signalsTableBody">
                    <!-- Заполняется через JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    /* Стилизация слайдеров */
    input[type="range"] {
        -webkit-appearance: none;
    }

    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        background: #2563eb;
        cursor: pointer;
        border-radius: 50%;
    }

    input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        background: #2563eb;
        cursor: pointer;
        border-radius: 50%;
        border: none;
    }

    /* Анимация появления */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
        animation: fadeIn 0.3s ease-out;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Глобальные переменные
    let savedFiltersData = {{ saved_filters|tojson }};
    let currentScoreWeek = 0;
    let currentScoreMonth = 0;

    // Обновление отображения значения слайдера
    function updateScoreDisplay(type, value) {
        if (type === 'week') {
            document.getElementById('scoreWeekValue').textContent = value;
            currentScoreWeek = parseInt(value);
        } else if (type === 'month') {
            document.getElementById('scoreMonthValue').textContent = value;
            currentScoreMonth = parseInt(value);
        }
        // Обновляем превью количества сигналов
        updatePreviewCount();
    }

    // Обновление информации о дате и превью сигналов
    function updateDateInfo() {
        const date = document.getElementById('dateFilter').value;

        fetch('/api/scoring/get_date_info', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                date: date,
                score_week: currentScoreWeek,
                score_month: currentScoreMonth
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                // Обновляем информацию о режимах рынка
                const regimes = result.market_regimes;
                const regimesHtml = `
                    <div class="text-center">
                        <div class="text-xs text-gray-600">BULL</div>
                        <div class="text-lg font-bold text-green-600">${regimes.BULL || 0}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-gray-600">NEUTRAL</div>
                        <div class="text-lg font-bold text-gray-600">${regimes.NEUTRAL || 0}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-gray-600">BEAR</div>
                        <div class="text-lg font-bold text-red-600">${regimes.BEAR || 0}</div>
                    </div>
                `;
                document.getElementById('marketRegimes').innerHTML = regimesHtml;

                // Доминирующий режим
                const dominantColor = result.dominant_regime === 'BULL' ? 'green' :
                                     result.dominant_regime === 'BEAR' ? 'red' : 'gray';
                document.getElementById('dominantRegime').innerHTML =
                    `<strong>Доминирующий режим:</strong>
                    <span class="font-bold text-${dominantColor}-600">${result.dominant_regime}</span>`;

                // Обновляем превью количества сигналов
                document.getElementById('previewCount').textContent = result.signal_count || 0;
            }
        })
        .catch(error => {
            console.error('Ошибка получения информации о дате:', error);
        });
    }

    // Обновление превью количества сигналов
    function updatePreviewCount() {
        const date = document.getElementById('dateFilter').value;

        fetch('/api/scoring/get_date_info', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                date: date,
                score_week: currentScoreWeek,
                score_month: currentScoreMonth
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                document.getElementById('previewCount').textContent = result.signal_count || 0;
            }
        });
    }

    // Применение фильтров
    function applyFilters() {
        const date = document.getElementById('dateFilter').value;
        const positionSize = parseFloat(document.getElementById('positionSize').value);
        const leverage = parseInt(document.getElementById('leverage').value);
        
        // Используем параметры из сохраненной стратегии
        const tp = {{ params.tp_percent|default(4.0) }};
        const sl = {{ params.sl_percent|default(3.0) }};

        // Проверка минимальных значений фильтров
        if (currentScoreWeek < -100 || currentScoreMonth < -100) {
            alert('Неверные значения фильтров');
            return;
        }

        // Получаем режим торговли
        fetch('/api/get_user_trading_mode')
            .then(response => response.json())
            .then(modeData => {
                const modeText = modeData.use_trailing_stop ?
                    `Trailing Stop (Activation: ${modeData.trailing_activation_pct}%, Distance: ${modeData.trailing_distance_pct}%)` :
                    `Fixed TP/SL`;

                // Подтверждение
                const message = `Будут обработаны сигналы с:\n` +
                              `- Score Week >= ${currentScoreWeek}\n` +
                              `- Score Month >= ${currentScoreMonth}\n\n` +
                              `Режим: ${modeText}\n` +
                              `Параметры: TP=${tp}%, SL=${sl}%, Size=$${positionSize}, Lev=${leverage}x\n\n` +
                              `Продолжить?`;

                if (!confirm(message)) {
                    return;
                }

                // Показываем индикатор загрузки
                const button = document.querySelector('button[onclick="applyFilters()"]');
                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Обработка...';

                // Отправляем запрос
                fetch('/api/scoring/apply_filters', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        date: date,
                        score_week_min: currentScoreWeek,
                        score_month_min: currentScoreMonth,
                        tp_percent: tp,
                        sl_percent: sl,
                        position_size: positionSize,
                        leverage: leverage
                    })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'success') {
                        updateResults(result.data);
                        showNotification(`Обработано ${result.data.stats.total} сигналов`, 'success');
                    } else {
                        alert('Ошибка: ' + result.message);
                    }
                })
                .catch(error => {
                    alert('Ошибка сети: ' + error);
                })
                .finally(() => {
                    button.disabled = false;
                    button.innerHTML = originalText;
                });
            });
    }

    // Обновление результатов
    function updateResults(data) {
        // Показываем контейнеры
        document.getElementById('statsContainer').style.display = 'block';
        document.getElementById('signalsContainer').style.display = 'block';

        // Обновляем статистику
        const stats = data.stats;
        const metrics = data.metrics;

        document.getElementById('statTotal').textContent = stats.total || 0;
        document.getElementById('statBuy').textContent = stats.buy_signals || 0;
        document.getElementById('statSell').textContent = stats.sell_signals || 0;
        document.getElementById('statTP').textContent = stats.tp_count || 0;
        document.getElementById('statSL').textContent = stats.sl_count || 0;
        document.getElementById('statTimeout').textContent = stats.timeout_count || 0;
        
        // Trailing Stop метрики
        document.getElementById('statTrailing').textContent = stats.trailing_count || 0;
        document.getElementById('statTrailingWin').textContent = stats.trailing_wins || 0;
        document.getElementById('statTrailingLoss').textContent = stats.trailing_losses || 0;
        document.getElementById('statTrailingEff').textContent = ((stats.trailing_efficiency || 0) * 100).toFixed(1) + '%';

        // P&L
        const pnlElement = document.getElementById('statPnL');
        const totalPnL = stats.total_pnl || 0;
        pnlElement.textContent = (totalPnL >= 0 ? '+' : '') + '$' + totalPnL.toFixed(2);

        // Цвет фона для P&L
        const pnlContainer = document.getElementById('pnlContainer');
        if (totalPnL >= 0) {
            pnlContainer.className = 'bg-green-50 p-3 rounded-lg';
            pnlElement.className = 'text-xl font-bold text-green-600';
        } else {
            pnlContainer.className = 'bg-red-50 p-3 rounded-lg';
            pnlElement.className = 'text-xl font-bold text-red-600';
        }

        // Метрики
        document.getElementById('statWinRate').textContent = (metrics.win_rate || 0).toFixed(1) + '%';
        document.getElementById('statEfficiency').textContent = (metrics.tp_efficiency || 0).toFixed(1) + '%';
        document.getElementById('statMaxPotential').textContent = '$' + (stats.max_potential || 0).toFixed(2);

        // Обновляем таблицу сигналов
        updateSignalsTable(data.signals);

        // Анимация появления
        document.getElementById('statsContainer').classList.add('fade-in');
        document.getElementById('signalsContainer').classList.add('fade-in');
    }

    // Обновление таблицы сигналов
    function updateSignalsTable(signals) {
        const tbody = document.getElementById('signalsTableBody');

        if (!signals || signals.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                        Нет сигналов по заданным фильтрам
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = signals.map(signal => {
            const time = new Date(signal.timestamp).toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit'
            });

            // Определяем статус badge
            let statusBadge = '';
            if (signal.close_reason === 'take_profit') {
                statusBadge = '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 font-medium">TP</span>';
            } else if (signal.close_reason === 'stop_loss') {
                statusBadge = '<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800 font-medium">SL</span>';
            } else if (signal.close_reason === 'trailing_stop') {
                const trailingColor = signal.pnl_usd >= 0 ? 'bg-purple-100 text-purple-800' : 'bg-orange-100 text-orange-800';
                statusBadge = `<span class="px-2 py-1 text-xs rounded-full ${trailingColor} font-medium">TRAIL</span>`;
            } else if (signal.close_reason === 'timeout') {
                statusBadge = '<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800 font-medium">TIMEOUT</span>';
            } else {
                statusBadge = '<span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800 font-medium">ОТКРЫТА</span>';
            }

            const pnlColor = signal.pnl_usd >= 0 ? 'text-green-600' : 'text-red-600';
            const pnlPrefix = signal.pnl_usd >= 0 ? '+' : '';

            return `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="flex flex-col">
                            <span class="text-sm font-medium text-gray-900">${time}</span>
                            <span class="text-xs text-gray-500">${signal.exchange_name || 'Unknown'}</span>
                        </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="text-sm font-medium text-gray-900">${signal.pair_symbol}</span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full font-medium ${
                            signal.signal_action === 'BUY' ?
                            'bg-green-100 text-green-800' :
                            'bg-red-100 text-red-800'
                        }">
                            ${signal.signal_action}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex flex-col space-y-0.5 text-xs">
                            <div>T: <span class="font-semibold">${signal.total_score.toFixed(1)}</span></div>
                            <div>W: <span class="font-semibold">${signal.score_week || 'N/A'}</span></div>
                            <div>M: <span class="font-semibold">${signal.score_month || 'N/A'}</span></div>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-900 font-mono">
                        ${signal.entry_price.toFixed(8)}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-900 font-mono">
                        ${signal.current_price.toFixed(8)}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="flex flex-col">
                            <span class="text-sm font-bold ${pnlColor}">
                                ${pnlPrefix}$${Math.abs(signal.pnl_usd).toFixed(2)}
                            </span>
                            <span class="text-xs ${pnlColor}">
                                ${signal.pnl_percent.toFixed(2)}%
                            </span>
                        </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="flex flex-col">
                            <span class="text-sm font-medium text-blue-600">
                                $${(signal.max_potential_profit || 0).toFixed(2)}
                            </span>
                        </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="flex items-center space-x-2">
                            ${statusBadge}
                            ${signal.hours_to_close ?
                                `<span class="text-xs text-gray-500">${signal.hours_to_close.toFixed(1)}ч</span>` :
                                ''
                            }
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Сохранение текущих фильтров
    function saveCurrentFilters() {
        const filterName = prompt('Введите название для набора фильтров:');
        if (!filterName) return;

        fetch('/api/scoring/save_filters', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: filterName,
                score_week_min: currentScoreWeek,
                score_month_min: currentScoreMonth
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                showNotification('Фильтры сохранены!', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                alert('Ошибка: ' + result.message);
            }
        });
    }

    // Загрузка сохраненного фильтра
    function loadSavedFilter() {
        const select = document.getElementById('savedFilters');
        const index = parseInt(select.value);

        if (isNaN(index)) return;

        const filter = savedFiltersData[index];
        if (filter) {
            // Устанавливаем значения слайдеров
            if (filter.score_week_min !== undefined) {
                document.getElementById('scoreWeekFilter').value = filter.score_week_min;
                updateScoreDisplay('week', filter.score_week_min);
            }
            if (filter.score_month_min !== undefined) {
                document.getElementById('scoreMonthFilter').value = filter.score_month_min;
                updateScoreDisplay('month', filter.score_month_min);
            }

            showNotification('Фильтры загружены', 'info');
        }
    }

    // Переключение режима торговли
    function switchTradingMode() {
        if (confirm('Перейти в настройки сигналов для изменения режима?')) {
            window.location.href = '/signal_performance';
        }
    }

    // Загрузка текущего режима
    function loadCurrentMode() {
        fetch('/api/get_user_trading_mode')
            .then(response => response.json())
            .then(data => {
                updateModeDisplay(data);
            })
            .catch(error => {
                console.error('Ошибка загрузки режима:', error);
            });
    }

    // Обновление отображения режима
    function updateModeDisplay(modeData) {
        const modeElement = document.getElementById('currentMode');
        if (!modeElement) return;

        if (modeData.use_trailing_stop) {
            modeElement.className = 'px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800';
            modeElement.innerHTML = `
                <i class="fas fa-chart-line mr-1"></i>
                Trailing Stop (Act: ${modeData.trailing_activation_pct}%, Dist: ${modeData.trailing_distance_pct}%)
            `;
        } else {
            modeElement.className = 'px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800';
            modeElement.innerHTML = `
                <i class="fas fa-lock mr-1"></i>
                Fixed TP/SL (TP: ${modeData.take_profit_percent}%, SL: ${modeData.insurance_sl || modeData.stop_loss_percent}%)
            `;
        }
    }

    // Функция показа уведомлений
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-6 py-4 rounded-lg shadow-lg transition-all duration-500 z-50 ${
            type === 'success' ? 'bg-green-500 text-white' :
            type === 'info' ? 'bg-blue-500 text-white' :
            'bg-red-500 text-white'
        }`;
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas ${
                    type === 'success' ? 'fa-check-circle' :
                    type === 'info' ? 'fa-info-circle' :
                    'fa-exclamation-circle'
                } mr-3"></i>
                <span>${message}</span>
            </div>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 500);
        }, 3000);
    }

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        // Загружаем информацию о режимах рынка для текущей даты
        updateDateInfo();

        // Загружаем текущий режим торговли
        loadCurrentMode();

        // Устанавливаем начальные значения слайдеров
        updateScoreDisplay('week', 0);
        updateScoreDisplay('month', 0);
    });
</script>
{% endblock %}