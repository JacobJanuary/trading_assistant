<!-- templates/signal_performance.html -->
{% extends "base.html" %}

{% block title %}–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–∏–≥–Ω–∞–ª–æ–≤ - –ü–æ–º–æ—â–Ω–∏–∫ –¢—Ä–µ–π–¥–µ—Ä–∞{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö (–±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è) -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-info-circle mr-2 text-blue-600"></i>
            –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
        </h2>
        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
            <p class="text-sm text-gray-700">
                –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –±—ç–∫—Ç–µ—Å—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π –±–∏—Ä–∂–∏.
                SL, TS –∏ –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–±–∏—Ä–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö.
            </p>
            <div class="mt-3 grid grid-cols-2 gap-4">
                <div>
                    <span class="text-xs text-gray-600">Leverage:</span>
                    <span class="text-sm font-semibold text-gray-800">{{ filters.leverage }}x</span>
                </div>
                <div>
                    <span class="text-xs text-gray-600">–†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏:</span>
                    <span class="text-sm font-semibold text-gray-800">${{ filters.position_size_usd }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Exchange Filter -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-exchange-alt mr-2 text-blue-600"></i>
            –§–∏–ª—å—Ç—Ä –ø–æ –±–∏—Ä–∂–∞–º
        </h2>
        <div class="flex items-center space-x-6">
            <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" id="exchangeBinance" value="1" class="exchange-checkbox w-4 h-4 text-blue-600 rounded focus:ring-blue-500"
                       {% if 1 in filters.selected_exchanges %}checked{% endif %}>
                <span class="text-sm font-medium text-gray-700">
                    <span class="inline-flex items-center px-2 py-1 rounded-md bg-yellow-100 text-yellow-800">
                        <i class="fas fa-coins mr-1"></i> Binance
                    </span>
                </span>
            </label>
            <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" id="exchangeBybit" value="2" class="exchange-checkbox w-4 h-4 text-blue-600 rounded focus:ring-blue-500"
                       {% if 2 in filters.selected_exchanges %}checked{% endif %}>
                <span class="text-sm font-medium text-gray-700">
                    <span class="inline-flex items-center px-2 py-1 rounded-md bg-orange-100 text-orange-800">
                        <i class="fas fa-chart-line mr-1"></i> Bybit
                    </span>
                </span>
            </label>
            <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" id="exchangeCoinbase" value="3" class="exchange-checkbox w-4 h-4 text-blue-600 rounded focus:ring-blue-500"
                       {% if 3 in filters.selected_exchanges %}checked{% endif %}>
                <span class="text-sm font-medium text-gray-700">
                    <span class="inline-flex items-center px-2 py-1 rounded-md bg-blue-100 text-blue-800">
                        <i class="fas fa-university mr-1"></i> Coinbase
                    </span>
                </span>
            </label>
            <button onclick="applyExchangeFilter()" class="ml-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                <i class="fas fa-filter mr-1"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å
            </button>
        </div>
    </div>

    <!-- OI/Volume Filter -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-filter mr-2 text-blue-600"></i>
            –§–∏–ª—å—Ç—Ä –ø–æ OI/Volume
        </h2>
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" id="enableOiVolumeFilter" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500"
                           {% if filters.enable_oi_volume_filter %}checked{% endif %}
                           onchange="onOiVolumeFilterChange()">
                    <span class="text-sm font-medium text-gray-700">
                        –í–∫–ª—é—á–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã OI/Volume
                    </span>
                </label>
                <span id="oiVolumeFilterStatus" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium
                    {% if filters.enable_oi_volume_filter %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-600{% endif %}">
                    {% if filters.enable_oi_volume_filter %}
                        <i class="fas fa-check-circle mr-1"></i> –ê–ö–¢–ò–í–ï–ù
                    {% else %}
                        <i class="fas fa-times-circle mr-1"></i> –í–´–ö–õ–Æ–ß–ï–ù
                    {% endif %}
                </span>
            </div>
        </div>
        <div class="mt-4 bg-blue-50 p-4 rounded-lg border border-blue-200">
            <p class="text-sm text-gray-700">
                <i class="fas fa-info-circle mr-1 text-blue-600"></i>
                <strong>–ö—Ä–∏—Ç–µ—Ä–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:</strong>
            </p>
            <ul class="mt-2 text-sm text-gray-700 space-y-1 ml-5">
                <li>‚Ä¢ <strong>Open Interest:</strong> >= 500,000</li>
                <li>‚Ä¢ <strong>Volume USD:</strong> >= 10,000 (mark_price √ó volume)</li>
            </ul>
            <p class="mt-3 text-xs text-gray-600">
                –°–∏–≥–Ω–∞–ª—ã, –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —ç—Ç–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º, –±—É–¥—É—Ç –∏—Å–∫–ª—é—á–µ–Ω—ã –∏–∑ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.
                –î–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ —Å–≤–µ—á–µ–π 15m –Ω–∞ –º–æ–º–µ–Ω—Ç –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–∞.
            </p>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-chart-bar mr-2 text-blue-600"></i>
            –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (—Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤)
        </h2>

        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
            <div class="bg-blue-50 p-3 rounded-lg">
                <div class="text-xs text-gray-600">–í—Å–µ–≥–æ –≤ –ë–î</div>
                <div class="text-xl font-bold text-blue-600">{{ total_stats.total_all }}</div>
            </div>
            <div class="bg-purple-50 p-3 rounded-lg">
                <div class="text-xs text-gray-600">–ü–æ–∫–∞–∑–∞–Ω–æ</div>
                <div class="text-xl font-bold text-purple-600">{{ stats.total }}</div>
            </div>
            <div class="bg-green-50 p-3 rounded-lg">
                <div class="text-xs text-gray-600">–û—Ç–∫—Ä—ã—Ç—ã—Ö</div>
                <div class="text-xl font-bold text-green-600">{{ stats.open }}</div>
            </div>
            <div class="bg-emerald-50 p-3 rounded-lg">
                <div class="text-xs text-gray-600">–ü–æ TP</div>
                <div class="text-xl font-bold text-emerald-600">{{ stats.closed_tp }}</div>
            </div>
            <div class="bg-red-50 p-3 rounded-lg">
                <div class="text-xs text-gray-600">–ü–æ SL</div>
                <div class="text-xl font-bold text-red-600">{{ stats.closed_sl }}</div>
            </div>
            <div class="bg-purple-50 p-3 rounded-lg">
                <div class="text-xs text-gray-600">–ü–æ Trailing</div>
                <div class="text-xl font-bold text-purple-600">{{ efficiency.closed_trailing|default(0) }}</div>
            </div>
            <div class="{% if stats.total_pnl >= 0 %}bg-green-50{% else %}bg-red-50{% endif %} p-3 rounded-lg">
                <div class="text-xs text-gray-600">P&L</div>
                <div class="text-xl font-bold {% if stats.total_pnl >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                    {% if stats.total_pnl >= 0 %}+{% endif %}${{ "%.2f"|format(stats.total_pnl) }}
                </div>
            </div>
        </div>

        {% if stats.closed_tp + stats.closed_sl > 0 %}
        <div class="mt-4 bg-blue-100 p-3 rounded-lg">
            <span class="text-sm text-gray-700">Win Rate: </span>
            <span class="text-lg font-bold text-blue-700">{{ "%.1f"|format(stats.win_rate) }}%</span>
        </div>
        {% endif %}
    </div>

    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-chart-area mr-2 text-purple-600"></i>
            –ê–Ω–∞–ª–∏–∑ Trailing Stop
        </h2>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ Trailing Stop -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">

            <!-- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å Trailing -->
            <div class="bg-gradient-to-br from-purple-50 to-indigo-100 p-4 rounded-lg">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="text-sm font-medium text-gray-700">Trailing Stop –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
                        <p class="text-2xl font-bold text-purple-700 mt-1">
                            {% if efficiency.closed_trailing > 0 %}
                            {{ "%.1f"|format((efficiency.trailing_wins / efficiency.closed_trailing) * 100) }}%
                            {% else %}
                            N/A
                            {% endif %}
                        </p>
                    </div>
                    <div class="text-purple-600">
                        <i class="fas fa-wave-square text-2xl"></i>
                    </div>
                </div>
                <div class="text-xs text-gray-600 space-y-1">
                    <div>–í—Å–µ–≥–æ Trailing: <span class="font-semibold">{{ efficiency.closed_trailing|default(0) }}</span>
                    </div>
                    <div>–ü—Ä–∏–±—ã–ª—å–Ω—ã—Ö: <span class="font-semibold text-green-700">{{ efficiency.trailing_wins|default(0) }}</span>
                    </div>
                    <div>–£–±—ã—Ç–æ—á–Ω—ã—Ö: <span
                            class="font-semibold text-red-700">{{ efficiency.trailing_losses|default(0) }}</span></div>
                </div>
            </div>

            <!-- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å Fixed TP -->
            <div class="bg-gradient-to-br from-blue-50 to-cyan-100 p-4 rounded-lg">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="text-sm font-medium text-gray-700">Trailing vs Fixed TP</h3>
                        <p class="text-lg font-bold text-blue-700 mt-1">
                            {% set trailing_avg = efficiency.trailing_avg_profit|default(0) %}
                            {% set tp_avg = efficiency.tp_avg_profit|default(0) %}
                            {% if trailing_avg > 0 and tp_avg > 0 %}
                                {% set diff_pct = ((trailing_avg - tp_avg) / tp_avg * 100) %}
                                {% if trailing_avg > tp_avg %}
                                <span class="text-green-600">+{{ "%.1f"|format(diff_pct) }}%</span>
                                {% else %}
                                <span class="text-red-600">{{ "%.1f"|format(diff_pct) }}%</span>
                                {% endif %}
                            {% elif trailing_avg > 0 and tp_avg == 0 %}
                                <span class="text-green-600">Trailing –ª—É—á—à–µ</span>
                            {% elif tp_avg > 0 and trailing_avg == 0 %}
                                <span class="text-blue-600">Fixed TP –ª—É—á—à–µ</span>
                            {% elif trailing_avg > 0 %}
                                <span class="text-blue-600">Trailing</span>
                            {% elif tp_avg > 0 %}
                                <span class="text-blue-600">Fixed TP</span>
                            {% else %}
                                <span class="text-gray-500">N/A</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="text-blue-600">
                        <i class="fas fa-balance-scale text-2xl"></i>
                    </div>
                </div>
                <div class="text-xs text-gray-600 space-y-1">
                    <div>–°—Ä. Trailing: <span class="font-semibold">${{ "%.2f"|format(trailing_avg) }}</span></div>
                    <div>–°—Ä. Fixed TP: <span class="font-semibold">${{ "%.2f"|format(tp_avg) }}</span></div>
                    <div>–†–∞–∑–Ω–∏—Ü–∞: <span
                            class="font-semibold {% if trailing_avg > tp_avg %}text-green-700{% else %}text-red-700{% endif %}">
                    ${{ "%.2f"|format(trailing_avg - tp_avg) }}
                </span></div>
                </div>
            </div>

            <!-- –£–ø—É—â–µ–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏—Ç –ø–æ —Ä–µ–∂–∏–º–∞–º -->
            <div class="bg-gradient-to-br from-orange-50 to-yellow-100 p-4 rounded-lg">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="text-sm font-medium text-gray-700">–ó–∞—Ö–≤–∞—Ç –¥–≤–∏–∂–µ–Ω–∏—è</h3>
                        <p class="text-2xl font-bold text-orange-700 mt-1">
                            {% if efficiency.trailing_capture_rate is defined %}
                            {{ "%.1f"|format(efficiency.trailing_capture_rate) }}%
                            {% else %}
                            N/A
                            {% endif %}
                        </p>
                    </div>
                    <div class="text-orange-600">
                        <i class="fas fa-crosshairs text-2xl"></i>
                    </div>
                </div>
                <div class="text-xs text-gray-600 space-y-1">
                    <div>Max –¥–≤–∏–∂–µ–Ω–∏–µ: <span class="font-semibold">${{ "%.2f"|format(efficiency.trailing_max_movement|default(0)) }}</span>
                    </div>
                    <div>–ó–∞—Ö–≤–∞—á–µ–Ω–æ: <span class="font-semibold text-green-700">${{ "%.2f"|format(efficiency.trailing_captured|default(0)) }}</span>
                    </div>
                    <div>–£–ø—É—â–µ–Ω–æ: <span class="font-semibold text-orange-600">${{ "%.2f"|format(efficiency.trailing_missed|default(0)) }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤—ã—Ö–æ–¥–æ–≤ -->
        <div class="border-t pt-4">
            <h3 class="text-sm font-semibold text-gray-700 mb-3">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–æ—á–µ–∫ –≤—ã—Ö–æ–¥–∞</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                <!-- Trailing Stop —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ -->
                <div>
                    <h4 class="text-xs text-gray-600 mb-2">Trailing Stop: –∑–∞—Ö–≤–∞—Ç –æ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è</h4>
                    <div class="space-y-2">
                        {% if efficiency.exit_distribution %}
                        {% set ranges = [
                        {'label': '80-100%', 'count': efficiency.exit_distribution['80-100%']|default(0), 'color': 'green'},
                        {'label': '60-80%', 'count': efficiency.exit_distribution['60-80%']|default(0), 'color': 'blue'},
                        {'label': '40-60%', 'count': efficiency.exit_distribution['40-60%']|default(0), 'color': 'yellow'},
                        {'label': '20-40%', 'count': efficiency.exit_distribution['20-40%']|default(0), 'color': 'orange'},
                        {'label': '0-20%', 'count': efficiency.exit_distribution['0-20%']|default(0), 'color': 'red'}
                        ] %}

                        {% for range in ranges %}
                        <div class="flex items-center">
                            <span class="text-xs w-16 text-gray-600">{{ range.label }}</span>
                            <div class="flex-1 bg-gray-200 rounded-full h-4 ml-2 relative">
                                {% if efficiency.closed_trailing > 0 %}
                                <div class="bg-{{ range.color }}-500 h-4 rounded-full"
                                     style="width: {{ (range.count / efficiency.closed_trailing * 100)|round }}%"></div>
                                {% endif %}
                            </div>
                            <span class="text-xs ml-2 w-8 text-right">{{ range.count }}</span>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="text-xs text-gray-500 italic">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ trailing stop</div>
                        {% endif %}
                    </div>
                </div>


                <!-- –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å -->
                <div>
                    <h4 class="text-xs text-gray-600 mb-2">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞—Ö–≤–∞—Ç–∞ –ø–æ —Ä–µ–∂–∏–º–∞–º</h4>
                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span>Fixed TP</span>
                                <span>{{ "%.1f"|format(efficiency.tp_efficiency) }}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="bg-blue-500 h-3 rounded-full"
                                     style="width: {{ efficiency.tp_efficiency }}%"></div>
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span>Trailing Stop</span>
                                <span>{{ "%.1f"|format(efficiency.trailing_efficiency|default(0)) }}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="bg-purple-500 h-3 rounded-full"
                                     style="width: {{ efficiency.trailing_efficiency|default(0) }}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ -->
        {% if efficiency.closed_trailing > 5 %}
        <div class="mt-4 bg-purple-50 p-3 rounded-lg">
            <div class="text-xs text-gray-700">
                <i class="fas fa-lightbulb mr-1 text-purple-600"></i>
                <strong>–ê–Ω–∞–ª–∏–∑ Trailing Stop:</strong>

                {% if efficiency.trailing_avg_profit|default(0) > 0 and efficiency.tp_avg_profit|default(0) > 0 %}
                    {% if efficiency.trailing_avg_profit > efficiency.tp_avg_profit %}
                    <span class="text-green-700">‚úì Trailing Stop —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ: —Å—Ä–µ–¥–Ω–∏–π –ø—Ä–æ—Ñ–∏—Ç ${{ "%.2f"|format(efficiency.trailing_avg_profit) }} vs ${{ "%.2f"|format(efficiency.tp_avg_profit) }} Fixed TP (+{{ "%.1f"|format((efficiency.trailing_avg_profit - efficiency.tp_avg_profit) / efficiency.tp_avg_profit * 100) }}%)</span>
                    {% else %}
                    <span class="text-orange-700">‚ö† Fixed TP —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ: —Å—Ä–µ–¥–Ω–∏–π –ø—Ä–æ—Ñ–∏—Ç ${{ "%.2f"|format(efficiency.tp_avg_profit) }} vs ${{ "%.2f"|format(efficiency.trailing_avg_profit) }} Trailing ({{ "%.1f"|format((efficiency.tp_avg_profit - efficiency.trailing_avg_profit) / efficiency.tp_avg_profit * 100) }}% –ª—É—á—à–µ)</span>
                    {% endif %}
                {% elif efficiency.trailing_avg_profit|default(0) > 0 %}
                    <span class="text-blue-700">üìä –°—Ä–µ–¥–Ω–∏–π –ø—Ä–æ—Ñ–∏—Ç Trailing Stop: ${{ "%.2f"|format(efficiency.trailing_avg_profit) }} (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö Fixed TP –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è)</span>
                {% elif efficiency.tp_avg_profit|default(0) > 0 %}
                    <span class="text-blue-700">üìä –°—Ä–µ–¥–Ω–∏–π –ø—Ä–æ—Ñ–∏—Ç Fixed TP: ${{ "%.2f"|format(efficiency.tp_avg_profit) }} (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö Trailing Stop –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è)</span>
                {% else %}
                    <span class="text-gray-600">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤</span>
                {% endif %}

                {% if efficiency.trailing_capture_rate|default(0) < 50 %}
                <br><span class="text-red-600 mt-1">‚ö† –ù–∏–∑–∫–∏–π –∑–∞—Ö–≤–∞—Ç –¥–≤–∏–∂–µ–Ω–∏—è ({{ "%.1f"|format(efficiency.trailing_capture_rate) }}%). –í–æ–∑–º–æ–∂–Ω–æ, trailing —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ.</span>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–Ω–æ–≤—ã–π –±–ª–æ–∫) -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-chart-line mr-2 text-purple-600"></i>
            –ê–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
        </h2>

        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">

            <!-- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å Take Profit -->
            <div class="bg-gradient-to-br from-blue-50 to-indigo-100 p-4 rounded-lg">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="text-sm font-medium text-gray-700">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å TP</h3>
                        <p class="text-2xl font-bold text-indigo-700 mt-1">
                            {{ "%.1f"|format(efficiency.tp_efficiency) }}%
                        </p>
                    </div>
                    <div class="text-indigo-600">
                        <i class="fas fa-bullseye text-2xl"></i>
                    </div>
                </div>
                <div class="text-xs text-gray-600 space-y-1">
                    <!-- –ò–ó–ú–ï–ù–ï–ù–û: –±–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è -->
                    <div>–ü—Ä–∏–±—ã–ª—å –æ—Ç TP: <span class="font-semibold text-green-700">${{ "%.2f"|format(efficiency.tp_realized_profit) }}</span>
                    </div>
                    <div>–ú–∞–∫—Å –≤–æ–∑–º–æ–∂–Ω—ã–π: <span class="font-semibold text-blue-700">${{ "%.2f"|format(efficiency.tp_max_potential) }}</span>
                    </div>
                    <div>–£–ø—É—â–µ–Ω–æ –ø–æ TP: <span class="font-semibold text-orange-600">${{ "%.2f"|format(efficiency.missed_profit) }}</span>
                    </div>
                </div>
            </div>
            <!-- Win Rate -->
            <div class="bg-gradient-to-br from-green-50 to-emerald-100 p-4 rounded-lg">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="text-sm font-medium text-gray-700">Win Rate</h3>
                        <p class="text-2xl font-bold text-emerald-700 mt-1">
                            {{ "%.1f"|format(efficiency.win_rate) }}%
                        </p>
                    </div>
                    <div class="text-emerald-600">
                        <i class="fas fa-trophy text-2xl"></i>
                    </div>
                </div>
                <div class="text-xs text-gray-600 space-y-1">
                    <div>–ü—Ä–∏–±—ã–ª—å–Ω—ã—Ö: <span class="font-semibold text-green-700">{{ efficiency.total_wins|default(0) }}</span></div>
                    <div>–£–±—ã—Ç–æ—á–Ω—ã—Ö: <span class="font-semibold text-red-700">{{ efficiency.total_losses|default(0) }}</span></div>
                    <div>–°—Ä. –ø—Ä–æ—Ñ–∏—Ç: <span class="font-semibold">{{ "%.2f"|format(efficiency.avg_tp_percent|default(0) + efficiency.avg_trailing_percent|default(0)) }}%</span>
                    </div>
                </div>
            </div>

            <!-- –û–±—â–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å -->
            <div class="bg-gradient-to-br from-purple-50 to-pink-100 p-4 rounded-lg">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="text-sm font-medium text-gray-700">–û–±—â–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
                        <p class="text-2xl font-bold text-purple-700 mt-1">
                            {{ "%.1f"|format(efficiency.overall_efficiency) }}%
                        </p>
                    </div>
                    <div class="text-purple-600">
                        <i class="fas fa-rocket text-2xl"></i>
                    </div>
                </div>
                <div class="text-xs text-gray-600 space-y-1">
                    <div>–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å: <span
                            class="font-semibold {% if efficiency.net_realized_pnl >= 0 %}text-green-700{% else %}text-red-700{% endif %}">
                    ${{ "%.2f"|format(efficiency.net_realized_pnl) }}
                </span></div>
                    <div>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª: <span class="font-semibold text-blue-700">${{ "%.2f"|format(efficiency.total_max_potential) }}</span>
                    </div>
                    <div>–û—Ç–∫—Ä—ã—Ç—ã—Ö P&L: <span class="font-semibold">
                    ${{ "%.2f"|format(efficiency.unrealized_pnl) }}
                </span></div>
                </div>
            </div>
        </div>

        <!-- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
        <div class="border-t pt-4">
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-600">
                    <i class="fas fa-info-circle mr-1"></i>
                    –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫—É—é —á–∞—Å—Ç—å –æ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏—Ç–∞ —É–¥–∞–µ—Ç—Å—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å
                </div>
                <div class="flex items-center space-x-4">
                    {% if efficiency.tp_efficiency < 50 %}
                    <span class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded">
                    <i class="fas fa-exclamation-triangle mr-1"></i>
                    –ù–∏–∑–∫–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å TP
                </span>
                    {% elif efficiency.tp_efficiency < 70 %}
                    <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">
                    <i class="fas fa-exclamation mr-1"></i>
                    –°—Ä–µ–¥–Ω—è—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å TP
                </span>
                    {% else %}
                    <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">
                    <i class="fas fa-check-circle mr-1"></i>
                    –•–æ—Ä–æ—à–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å TP
                </span>
                    {% endif %}
                </div>
            </div>

            <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
            <div class="mt-4">
                <div class="flex justify-between text-xs text-gray-600 mb-1">
                    <span>–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏—Ç</span>
                    <span>{{ "%.1f"|format(efficiency.tp_efficiency) }}% –æ—Ç –º–∞–∫—Å–∏–º—É–º–∞</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3 relative">
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 h-3 rounded-full"
                         style="width: {{ efficiency.tp_efficiency }}%"></div>
                    <div class="absolute inset-0 flex items-center justify-center">
                    <span class="text-xs font-semibold text-white drop-shadow">
                        ${{ "%.0f"|format(efficiency.tp_realized_profit) }} / ${{ "%.0f"|format(efficiency.tp_max_potential) }}
                    </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- –î–æ–±–∞–≤—å—Ç–µ –ø–æ—Å–ª–µ –±–ª–æ–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
    <div class="mt-4 bg-blue-50 p-3 rounded-lg">
        <div class="text-xs text-gray-700">
            <i class="fas fa-info-circle mr-1"></i>
            <strong>–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –º–µ—Ç—Ä–∏–∫:</strong>
            <ul class="mt-1 space-y-1">
                <li>‚Ä¢ <strong>P&L ({% if efficiency.total_pnl >= 0 %}+{% endif %}${{ "%.2f"|format(efficiency.total_pnl)
                    }})</strong> =
                    –ü—Ä–∏–±—ã–ª—å TP (${{ "%.2f"|format(efficiency.tp_realized_profit) }}) -
                    –£–±—ã—Ç–∫–∏ SL (${{ "%.2f"|format(efficiency.sl_realized_loss) }}) +
                    –û—Ç–∫—Ä—ã—Ç—ã–µ (${{ "%.2f"|format(efficiency.unrealized_pnl) }})
                </li>
                <li>‚Ä¢ <strong>–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å (${{ "%.2f"|format(efficiency.net_realized_pnl) }})</strong> =
                    –¢–æ–ª—å–∫–æ –∑–∞–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏ (TP - SL)
                </li>
                <li>‚Ä¢ <strong>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å TP</strong> =
                    –°–∫–æ–ª—å–∫–æ % –æ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏—Ç–∞ –º—ã –∑–∞–±–∏—Ä–∞–µ–º –ø–æ Take Profit
                </li>
            </ul>
        </div>
    </div>
    <!-- –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ –±–ª–æ–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
    {% if efficiency.tp_efficiency < 60 %}
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-lightbulb text-yellow-400"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-yellow-800">
                    –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                </h3>
                <div class="mt-2 text-sm text-yellow-700">
                    <ul class="list-disc list-inside space-y-1">
                        <li>–¢–µ–∫—É—â–∏–π TP ({{ filters.take_profit_percent }}%) –∑–∞–±–∏—Ä–∞–µ—Ç —Ç–æ–ª—å–∫–æ {{
                            "%.1f"|format(efficiency.tp_efficiency) }}% –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏—Ç–∞
                        </li>
                        <li>–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ TP –¥–æ 5-6% –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –±–æ–ª—å—à–µ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è</li>
                        <li>–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ trailing stop –¥–ª—è —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∑–∞ —Ç—Ä–µ–Ω–¥–æ–º</li>
                        <li>–£–ø—É—â–µ–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏—Ç —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç ${{ "%.2f"|format(efficiency.missed_profit) }}</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- –¢–∞–±–ª–∏—Ü–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between">
            <h2 class="text-lg font-semibold text-gray-800">
                <i class="fas fa-list mr-2"></i>
                –°–∏–≥–Ω–∞–ª—ã
            </h2>
            <span class="text-sm text-gray-600">
                –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
            </span>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–ü–∞—Ä–∞</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–ë–∏—Ä–∂–∞</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–¢–∏–ø</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Score W/M</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–í–æ–∑—Ä–∞—Å—Ç</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–í—Ö–æ–¥</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–¢–µ–∫—É—â–∞—è</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">P&L ($)</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">P&L (%)</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–ú–∞–∫—Å</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–°—Ç–∞—Ç—É—Å</th>
                </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                {% for signal in signals %}
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">{{ signal.pair_symbol }}</td>
                    <td class="px-4 py-3 text-sm">
                        {% if signal.exchange_name == 'Binance' %}
                            <span class="px-2 py-1 text-xs rounded-md bg-yellow-100 text-yellow-800">
                                <i class="fas fa-coins"></i> {{ signal.exchange_name }}
                            </span>
                        {% elif signal.exchange_name == 'Bybit' %}
                            <span class="px-2 py-1 text-xs rounded-md bg-orange-100 text-orange-800">
                                <i class="fas fa-chart-line"></i> {{ signal.exchange_name }}
                            </span>
                        {% elif signal.exchange_name == 'Coinbase' %}
                            <span class="px-2 py-1 text-xs rounded-md bg-blue-100 text-blue-800">
                                <i class="fas fa-university"></i> {{ signal.exchange_name }}
                            </span>
                        {% else %}
                            <span class="px-2 py-1 text-xs rounded-md bg-gray-100 text-gray-800">
                                {{ signal.exchange_name|default('Unknown') }}
                            </span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 text-xs rounded-full
                                {% if signal.signal_action in ['SELL', 'SHORT'] %}bg-red-100 text-red-800
                                {% else %}bg-green-100 text-green-800{% endif %}">
                                {{ signal.signal_action }}
                            </span>
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <div class="flex flex-col">
                            <span class="font-medium {% if signal.score_week|default(0) > 0 %}text-green-600{% elif signal.score_week|default(0) < 0 %}text-red-600{% else %}text-gray-600{% endif %}">
                                W: {{ signal.score_week|default('N/A') }}
                            </span>
                            <span class="text-xs {% if signal.score_month|default(0) > 0 %}text-green-600{% elif signal.score_month|default(0) < 0 %}text-red-600{% else %}text-gray-600{% endif %}">
                                M: {{ signal.score_month|default('N/A') }}
                            </span>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">{{ signal.age_hours }}—á</td>
                    <td class="px-4 py-3 text-sm text-gray-900">{{ "%.8f"|format(signal.entry_price) }}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">
                        {% if signal.current_price %}
                        {{ "%.8f"|format(signal.current_price) }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-sm font-medium pnl-value
                            {% if signal.pnl_usd >= 0 %}text-green-600{% else %}text-red-600{% endif %}"
                        data-base="{{ signal.pnl_usd }}">
                        {% if signal.pnl_usd >= 0 %}+{% endif %}{{ "%.2f"|format(signal.pnl_usd) }}
                    </td>
                    <td class="px-4 py-3 text-sm
                            {% if signal.pnl_percent >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                        {% if signal.pnl_percent >= 0 %}+{% endif %}{{ "%.2f"|format(signal.pnl_percent) }}%
                    </td>
                    <td class="px-4 py-3 text-sm text-blue-600 max-profit-value"
                        data-base="{{ signal.max_potential_profit_usd }}">
                        {% if signal.max_potential_profit_usd > 0 %}
                        ${{ "%.2f"|format(signal.max_potential_profit_usd) }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-sm">
                        {% if signal.is_closed %}
                        <span class="px-2 py-1 text-xs rounded-full
                                    {% if signal.close_reason == 'stop_loss' %}bg-red-100 text-red-800
                                    {% elif signal.close_reason == 'take_profit' %}bg-green-100 text-green-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ signal.close_reason|upper|replace('_', ' ') }}
                                </span>
                        {% else %}
                        <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">
                                    –û–¢–ö–†–´–¢–ê
                                </span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="mt-4 text-center text-sm text-gray-600">
        <i class="fas fa-info-circle mr-1"></i>
        –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: {{ last_update.strftime('%H:%M:%S') }}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
    setTimeout(() => location.reload(), 60000);

    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤—Ä–µ–º–µ–Ω–∏
    function applyTimeFilters() {
        const params = new URLSearchParams({
            hide_younger: document.getElementById('hideYounger').value,
            hide_older: document.getElementById('hideOlder').value,
            leverage: document.getElementById('leverage').value,
            position_size: document.getElementById('positionSize').value,
            score_week: document.getElementById('scoreWeek').value,
            score_month: document.getElementById('scoreMonth').value
        });
        window.location.href = '/signal_performance?' + params.toString();
    }
    
    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–æ—Ä–∏–Ω–≥–æ–≤—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function applyScoringFilters() {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã —Å–∫–æ—Ä–∏–Ω–≥–∞ –≤ –ë–î
        const scoreWeek = parseInt(document.getElementById('scoreWeek').value || 0);
        const scoreMonth = parseInt(document.getElementById('scoreMonth').value || 0);
        const maxTradesPer15Min = parseInt(document.getElementById('maxTradesPer15Min').value || 3);
        
        // –°–æ–±–∏—Ä–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —á–∞—Å—ã
        const selectedHours = [];
        document.querySelectorAll('.hour-filter:checked').forEach(checkbox => {
            selectedHours.push(parseInt(checkbox.value));
        });
        
        const data = {
            score_week_min: scoreWeek,
            score_month_min: scoreMonth,
            max_trades_per_15min: maxTradesPer15Min,
            // –¢–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
            hide_younger_than_hours: parseInt(document.getElementById('hideYounger').value),
            hide_older_than_hours: parseInt(document.getElementById('hideOlder').value),
            leverage: parseInt(document.getElementById('leverage').value),
            position_size_usd: parseFloat(document.getElementById('positionSize').value),
            // –í–ê–ñ–ù–û: –ø–µ—Ä–µ–¥–∞–µ–º —Ç–µ–∫—É—â–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —á–∞—Å—ã
            allowed_hours: selectedHours.length > 0 ? selectedHours : [...Array(24).keys()]
        };
        
        // –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
        fetch('/api/save_filters', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            // –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
            const params = new URLSearchParams({
                hide_younger: document.getElementById('hideYounger').value,
                hide_older: document.getElementById('hideOlder').value,
                leverage: document.getElementById('leverage').value,
                position_size: document.getElementById('positionSize').value,
                score_week: scoreWeek,
                score_month: scoreMonth
            });
            window.location.href = '/signal_performance?' + params.toString();
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤:', error);
            // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤—Å–µ —Ä–∞–≤–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
            const params = new URLSearchParams({
                hide_younger: document.getElementById('hideYounger').value,
                hide_older: document.getElementById('hideOlder').value,
                leverage: document.getElementById('leverage').value,
                position_size: document.getElementById('positionSize').value,
                score_week: scoreWeek,
                score_month: scoreMonth
            });
            window.location.href = '/signal_performance?' + params.toString();
        });
    }

    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ä–∞—Å—á–µ—Ç–∞ (leverage –∏ position_size)
    function applyCalculationParams() {
        const params = new URLSearchParams({
            hide_younger: document.getElementById('hideYounger').value,
            hide_older: document.getElementById('hideOlder').value,
            leverage: document.getElementById('leverage').value,
            position_size: document.getElementById('positionSize').value,
            score_week: document.getElementById('scoreWeek').value,
            score_month: document.getElementById('scoreMonth').value
        });
        window.location.href = '/signal_performance?' + params.toString();
    }

    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –±–∏—Ä–∂–∞–º
    function applyExchangeFilter() {
        // –°–æ–±–∏—Ä–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –±–∏—Ä–∂–∏
        const selectedExchanges = [];
        document.querySelectorAll('.exchange-checkbox:checked').forEach(checkbox => {
            selectedExchanges.push(parseInt(checkbox.value));
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞: –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã–±—Ä–∞–Ω–∞ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –±–∏—Ä–∂–∞
        if (selectedExchanges.length === 0) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –±–∏—Ä–∂—É!');
            return;
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –±–∏—Ä–∂–∏ –≤ –ë–î –≤–º–µ—Å—Ç–µ —Å –¥—Ä—É–≥–∏–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
        const data = {
            selected_exchanges: selectedExchanges,
            hide_younger_than_hours: parseInt(document.getElementById('hideYounger')?.value || 6),
            hide_older_than_hours: parseInt(document.getElementById('hideOlder')?.value || 48),
            leverage: parseInt(document.getElementById('leverage')?.value || 5),
            position_size_usd: parseFloat(document.getElementById('positionSize')?.value || 100),
            score_week_min: parseInt(document.getElementById('scoreWeek')?.value || 0),
            score_month_min: parseInt(document.getElementById('scoreMonth')?.value || 0),
            max_trades_per_15min: parseInt(document.getElementById('maxTradesPer15Min')?.value || 3),
            allowed_hours: Array.from(document.querySelectorAll('.hour-filter:checked')).map(cb => parseInt(cb.value))
        };

        console.log('Saving exchange filter:', data);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
        fetch('/api/save_filters', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            console.log('Exchange filter saved:', result);
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞
            window.location.reload();
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –±–∏—Ä–∂–∞–º:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        });
    }

    // OI/Volume Filter Functions
    let oiVolumeFilterDebounce = null;

    function onOiVolumeFilterChange() {
        const checkbox = document.getElementById('enableOiVolumeFilter');
        const statusBadge = document.getElementById('oiVolumeFilterStatus');

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
        if (checkbox.checked) {
            statusBadge.className = 'inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800';
            statusBadge.innerHTML = '<i class="fas fa-check-circle mr-1"></i> –ê–ö–¢–ò–í–ï–ù';
        } else {
            statusBadge.className = 'inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600';
            statusBadge.innerHTML = '<i class="fas fa-times-circle mr-1"></i> –í–´–ö–õ–Æ–ß–ï–ù';
        }

        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä —Å debounce (500ms)
        clearTimeout(oiVolumeFilterDebounce);
        oiVolumeFilterDebounce = setTimeout(() => {
            applyOiVolumeFilter();
        }, 500);
    }

    function applyOiVolumeFilter() {
        const enableOiVolumeFilter = document.getElementById('enableOiVolumeFilter').checked;

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î –≤–º–µ—Å—Ç–µ —Å –¥—Ä—É–≥–∏–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
        const data = {
            enable_oi_volume_filter: enableOiVolumeFilter,
            selected_exchanges: Array.from(document.querySelectorAll('.exchange-checkbox:checked')).map(cb => parseInt(cb.value)),
            hide_younger_than_hours: parseInt(document.getElementById('hideYounger')?.value || 6),
            hide_older_than_hours: parseInt(document.getElementById('hideOlder')?.value || 48),
            leverage: parseInt(document.getElementById('leverage')?.value || 5),
            position_size_usd: parseFloat(document.getElementById('positionSize')?.value || 100),
            score_week_min: parseInt(document.getElementById('scoreWeek')?.value || 0),
            score_month_min: parseInt(document.getElementById('scoreMonth')?.value || 0),
            max_trades_per_15min: parseInt(document.getElementById('maxTradesPer15Min')?.value || 3),
            allowed_hours: Array.from(document.querySelectorAll('.hour-filter:checked')).map(cb => parseInt(cb.value))
        };

        console.log('Saving OI/Volume filter:', data);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
        fetch('/api/save_filters', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            console.log('OI/Volume filter saved:', result);
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞
            window.location.reload();
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è OI/Volume —Ñ–∏–ª—å—Ç—Ä–∞:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        });
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ TP/SL
    function showReinitWarning() {
        document.getElementById('reinitWarning').classList.remove('hidden');
    }


    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ –ë–î
    function saveCalculationParams() {
        // –°–æ–±–∏—Ä–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —á–∞—Å—ã
        const selectedHours = [];
        document.querySelectorAll('.hour-filter:checked').forEach(checkbox => {
            selectedHours.push(parseInt(checkbox.value));
        });
        
        const data = {
            hide_younger_than_hours: parseInt(document.getElementById('hideYounger').value),
            hide_older_than_hours: parseInt(document.getElementById('hideOlder').value),
            leverage: parseInt(document.getElementById('leverage').value),
            position_size_usd: parseFloat(document.getElementById('positionSize').value),
            score_week_min: parseInt(document.getElementById('scoreWeek').value || 0),
            score_month_min: parseInt(document.getElementById('scoreMonth').value || 0),
            // –í–ê–ñ–ù–û: –ø–µ—Ä–µ–¥–∞–µ–º —Ç–µ–∫—É—â–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —á–∞—Å—ã
            allowed_hours: selectedHours.length > 0 ? selectedHours : [...Array(24).keys()]
        };

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const button = event.target.closest('button');
        const originalHTML = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

        fetch('/api/save_filters', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                showNotification('–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
                // –°–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
                const indicator = document.getElementById('unsavedIndicator');
                if (indicator) {
                    indicator.classList.add('hidden');
                }
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                if (window.savedValues) {
                    window.savedValues.leverage = data.leverage;
                    window.savedValues.positionSize = data.position_size_usd;
                }
            } else {
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
            }
        })
        .catch(error => {
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error, 'error');
        })
        .finally(() => {
            button.disabled = false;
            button.innerHTML = originalHTML;
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —á–∞—Å–∞–º
    function selectAllHours() {
        document.querySelectorAll('.hour-filter').forEach(checkbox => {
            checkbox.checked = true;
        });
    }

    function clearAllHours() {
        document.querySelectorAll('.hour-filter').forEach(checkbox => {
            checkbox.checked = false;
        });
    }

    function applyHourFilter() {
        const selectedHours = [];
        document.querySelectorAll('.hour-filter:checked').forEach(checkbox => {
            selectedHours.push(parseInt(checkbox.value));
        });

        if (selectedHours.length === 0) {
            showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —á–∞—Å', 'error');
            return;
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ —á–∞—Å–∞–º
        const data = {
            allowed_hours: selectedHours,
            // –¢–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
            hide_younger_than_hours: parseInt(document.getElementById('hideYounger').value),
            hide_older_than_hours: parseInt(document.getElementById('hideOlder').value),
            leverage: parseInt(document.getElementById('leverage').value),
            position_size_usd: parseFloat(document.getElementById('positionSize').value),
            score_week_min: parseInt(document.getElementById('scoreWeek').value || 0),
            score_month_min: parseInt(document.getElementById('scoreMonth').value || 0)
        };

        fetch('/api/save_filters', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –Ω–æ–≤—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
                const params = new URLSearchParams({
                    hide_younger: document.getElementById('hideYounger').value,
                    hide_older: document.getElementById('hideOlder').value,
                    leverage: document.getElementById('leverage').value,
                    position_size: document.getElementById('positionSize').value,
                    score_week: document.getElementById('scoreWeek').value,
                    score_month: document.getElementById('scoreMonth').value
                });
                window.location.href = '/signal_performance?' + params.toString();
            } else {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞', 'error');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞', 'error');
        });
    }

    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-6 py-4 rounded-lg shadow-lg transition-all duration-500 z-50 ${
            type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
        }`;
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-3"></i>
                <span>${message}</span>
            </div>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 500);
        }, 3000);
    }

    // –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        window.savedValues = {
            leverage: {{ filters.saved_leverage|default(5) }},
            positionSize: {{ filters.saved_position_size|default(100) }},
            hideYounger: {{ filters.hide_younger_than_hours|default(6) }},
            hideOlder: {{ filters.hide_older_than_hours|default(48) }}
        };

        // –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã
        const leverageInput = document.getElementById('leverage');
        const positionSizeInput = document.getElementById('positionSize');
        const hideYoungerInput = document.getElementById('hideYounger');
        const hideOlderInput = document.getElementById('hideOlder');
        const indicator = document.getElementById('unsavedIndicator');

        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        function checkChanges() {
            if (!indicator) return;

            const currentLeverage = parseInt(leverageInput.value);
            const currentPositionSize = parseFloat(positionSizeInput.value);
            const currentHideYounger = parseInt(hideYoungerInput.value);
            const currentHideOlder = parseInt(hideOlderInput.value);

            const hasChanges =
                currentLeverage !== window.savedValues.leverage ||
                currentPositionSize !== window.savedValues.positionSize ||
                currentHideYounger !== window.savedValues.hideYounger ||
                currentHideOlder !== window.savedValues.hideOlder;

            if (hasChanges) {
                indicator.classList.remove('hidden');
            } else {
                indicator.classList.add('hidden');
            }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π
        if (leverageInput) leverageInput.addEventListener('input', checkChanges);
        if (positionSizeInput) positionSizeInput.addEventListener('input', checkChanges);
        if (hideYoungerInput) hideYoungerInput.addEventListener('input', checkChanges);
        if (hideOlderInput) hideOlderInput.addEventListener('input', checkChanges);

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ input –ø–æ–ª—è—Ö
        const allInputs = [leverageInput, positionSizeInput, hideYoungerInput, hideOlderInput];
        allInputs.forEach(input => {
            if (input) {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        applyCalculationParams();
                    }
                });
            }
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏
        const applyButton = document.querySelector('button[onclick*="applyCalculationParams"]');
        const saveButton = document.querySelector('button[onclick*="saveCalculationParams"]');

        if (applyButton) {
            applyButton.title = '–ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞';
        }
        if (saveButton) {
            saveButton.title = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é';
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º –∏–∑ –ë–î
        fetch('/api/get_user_trading_mode')
            .then(response => {
                if (!response.ok) throw new Error('API not available');
                return response.json();
            })
            .then(data => {
                if (data && data.use_trailing_stop) {
                    const trailingMode = document.getElementById('trailingMode');
                    if (trailingMode) {
                        trailingMode.checked = true;
                        const trailingDistance = document.getElementById('trailingDistance');
                        const trailingActivation = document.getElementById('trailingActivation'); 
                        const trailingStopLoss = document.getElementById('trailingStopLoss');
                        
                        if (trailingDistance) trailingDistance.value = data.trailing_distance_pct || 2.0;
                        if (trailingActivation) trailingActivation.value = data.trailing_activation_pct || 1.0;
                        if (trailingStopLoss) trailingStopLoss.value = data.stop_loss || 3.0;
                        
                        toggleStopMode();
                    }
                }
            })
            .catch(err => {
                console.log('Trading mode API not available:', err);
            });
    });

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–∏—Å–µ–ª
    function formatNumber(num, decimals = 2) {
        return new Intl.NumberFormat('en-US', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        }).format(num);
    }

    // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ CSV (–µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è)
    function exportToCSV() {
        const table = document.querySelector('table');
        if (!table) {
            showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'error');
            return;
        }

        let csv = [];
        const rows = table.querySelectorAll('tr');

        for (let i = 0; i < rows.length; i++) {
            const row = [];
            const cols = rows[i].querySelectorAll('td, th');

            for (let j = 0; j < cols.length; j++) {
                row.push(cols[j].innerText);
            }

            csv.push(row.join(','));
        }

        const csvContent = csv.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('hidden', '');
        a.setAttribute('href', url);
        a.setAttribute('download', `signals_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –±–ª–æ–∫ scripts –≤ signal_performance.html

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Å—Ç–æ–ø–æ–≤
function toggleStopMode() {
    const trailingMode = document.getElementById('trailingMode');
    const isTrailing = trailingMode && trailingMode.checked;
    const fixedParams = document.getElementById('fixedParams');
    const trailingParams = document.getElementById('trailingParams');
    const applyButton = document.getElementById('applyButtonText');

    if (isTrailing) {
        if (fixedParams) fixedParams.classList.add('hidden');
        if (trailingParams) trailingParams.classList.remove('hidden');
        if (applyButton) applyButton.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∂–∏–º';
    } else {
        if (fixedParams) fixedParams.classList.remove('hidden');
        if (trailingParams) trailingParams.classList.add('hidden');
        if (applyButton) applyButton.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∂–∏–º';
    }
    
    // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, —Ç–∞–∫ –∫–∞–∫ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–ø–µ—Ä—å –æ—Ç–¥–µ–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞
    // showReinitWarning();
}


// –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
function applyTradingMode() {
    const isTrailing = document.getElementById('trailingMode').checked;
    const button = event.target.closest('button');
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

    // –°–æ–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞
    let params = {
        use_trailing_stop: isTrailing
    };

    if (isTrailing) {
        params.trailing_distance = parseFloat(document.getElementById('trailingDistance').value);
        params.trailing_activation = parseFloat(document.getElementById('trailingActivation').value);
        params.trailing_stop_loss = parseFloat(document.getElementById('trailingStopLoss').value);
    } else {
        params.take_profit = parseFloat(document.getElementById('takeProfit').value);
        params.stop_loss = parseFloat(document.getElementById('stopLoss').value);
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∂–∏–º –±–µ–∑ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    fetch('/api/save_trading_mode', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(params)
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'success') {
            showNotification('–†–µ–∂–∏–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
            button.disabled = false;
            button.innerHTML = `<i class="fas fa-chart-line mr-1"></i>${isTrailing ? 'Trailing Stop –∞–∫—Ç–∏–≤–µ–Ω' : 'Fixed TP/SL –∞–∫—Ç–∏–≤–µ–Ω'}`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            updateTradingModeDisplay();
        } else {
            showNotification('–û—à–∏–±–∫–∞: ' + result.message, 'error');
            button.disabled = false;
            button.innerHTML = `<i class="fas fa-chart-line mr-1"></i>${isTrailing ? '–ü—Ä–∏–º–µ–Ω–∏—Ç—å Trailing Stop' : '–ü—Ä–∏–º–µ–Ω–∏—Ç—å Fixed TP/SL'}`;
        }
    })
    .catch(error => {
        showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error, 'error');
        button.disabled = false;
        button.innerHTML = `<i class="fas fa-chart-line mr-1"></i>–ü—Ä–∏–º–µ–Ω–∏—Ç—å`;
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
function updateTradingModeDisplay() {
    const isTrailing = document.getElementById('trailingMode').checked;
    const modeIndicators = document.querySelectorAll('[data-mode-indicator]');
    
    modeIndicators.forEach(indicator => {
        if (indicator.dataset.modeIndicator === 'trailing') {
            indicator.style.display = isTrailing ? 'block' : 'none';
        } else if (indicator.dataset.modeIndicator === 'fixed') {
            indicator.style.display = isTrailing ? 'none' : 'block';
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)
function reinitializeSignals() {
    const isTrailing = document.getElementById('trailingMode').checked;
    
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å–∏–≥–Ω–∞–ª—ã?\n–≠—Ç–æ —É–¥–∞–ª–∏—Ç —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç –∏—Ö –∑–∞–Ω–æ–≤–æ.`)) {
        return;
    }
    
    const button = event.target.closest('button');
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...';
    
    let params = {
        hours: 48,
        use_trailing_stop: isTrailing
    };
    
    if (isTrailing) {
        params.trailing_distance = parseFloat(document.getElementById('trailingDistance').value);
        params.trailing_activation = parseFloat(document.getElementById('trailingActivation').value);
        params.stop_loss = parseFloat(document.getElementById('trailingStopLoss').value);
    } else {
        params.take_profit = parseFloat(document.getElementById('takeProfit').value);
        params.stop_loss = parseFloat(document.getElementById('stopLoss').value);
    }
    
    fetch('/api/initialize_signals', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(params)
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'success') {
            showNotification(result.message, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification('–û—à–∏–±–∫–∞: ' + result.message, 'error');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-sync-alt mr-1"></i>–ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å';
        }
    })
    .catch(error => {
        showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error, 'error');
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-sync-alt mr-1"></i>–ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å';
    });
}


// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ trailing –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
function updateTrailingStats() {
    fetch('/api/get_trailing_stats')
        .then(response => response.json())
        .then(data => {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            document.querySelectorAll('[data-trailing-stat]').forEach(el => {
                const stat = el.dataset.trailingStat;
                if (data[stat] !== undefined) {
                    el.textContent = formatValue(data[stat], el.dataset.format || 'number');
                }
            });
        })
        .catch(console.error);
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π
function formatValue(value, format) {
    switch(format) {
        case 'percent':
            return `${value.toFixed(1)}%`;
        case 'currency':
            return `$${value.toFixed(2)}`;
        default:
            return value.toString();
    }
}

// –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(updateTrailingStats, 30000);
</script>
{% endblock %}