<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сравнение стратегий - Trading Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .strategy-card {
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        .strategy-card:hover {
            border-color: #007bff;
            box-shadow: 0 4px 8px rgba(0,123,255,0.2);
        }
        .strategy-card.winner {
            border-color: #28a745;
            background-color: #f8fff9;
        }
        .metric-box {
            padding: 15px;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            margin: 10px 0;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        .comparison-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .positive { color: #28a745; font-weight: bold; }
        .negative { color: #dc3545; font-weight: bold; }
        .neutral { color: #6c757d; }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-graph-up"></i> Trading Assistant
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/dashboard">Dashboard</a>
                <a class="nav-link" href="/scoring_analysis">Скоринг</a>
                <a class="nav-link active" href="/strategy_comparison">Сравнение стратегий</a>
                <a class="nav-link" href="/ab_testing">A/B Testing</a>
                <a class="nav-link" href="/logout">Выход</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <h2 class="mb-4">
            <i class="bi bi-bar-chart-line"></i> Визуальное сравнение стратегий
        </h2>

        <!-- Параметры сравнения -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-sliders"></i> Параметры сравнения</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label>Период анализа:</label>
                        <select id="period" class="form-select">
                            <option value="7">7 дней</option>
                            <option value="14">14 дней</option>
                            <option value="30" selected>30 дней</option>
                            <option value="60">60 дней</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label>Score Week Min:</label>
                        <input type="number" id="scoreWeek" class="form-control" value="70" min="0" max="100">
                    </div>
                    <div class="col-md-2">
                        <label>Score Month Min:</label>
                        <input type="number" id="scoreMonth" class="form-control" value="70" min="0" max="100">
                    </div>
                    <div class="col-md-2">
                        <label>Position Size ($):</label>
                        <input type="number" id="positionSize" class="form-control" value="100" min="10">
                    </div>
                    <div class="col-md-2">
                        <label>Leverage:</label>
                        <input type="number" id="leverage" class="form-control" value="5" min="1" max="20">
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                        <button class="btn btn-success w-100" onclick="runComparison()">
                            <i class="bi bi-play-fill"></i> Сравнить
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Результаты сравнения -->
        <div class="row mb-4" id="strategyCards" style="display: none;">
            <!-- Fixed TP/SL Strategy Card -->
            <div class="col-md-6">
                <div class="card strategy-card" id="fixedCard">
                    <div class="card-header bg-info text-white">
                        <h5><i class="bi bi-bullseye"></i> Fixed TP/SL Strategy</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="metric-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                    <h6>Total P&L</h6>
                                    <h3 id="fixedPnL">-</h3>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="metric-box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                    <h6>Win Rate</h6>
                                    <h3 id="fixedWinRate">-</h3>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-4 text-center">
                                <small class="text-muted">TP Count</small>
                                <h5 id="fixedTP">-</h5>
                            </div>
                            <div class="col-4 text-center">
                                <small class="text-muted">SL Count</small>
                                <h5 id="fixedSL">-</h5>
                            </div>
                            <div class="col-4 text-center">
                                <small class="text-muted">Avg Time</small>
                                <h5 id="fixedTime">-</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trailing Stop Strategy Card -->
            <div class="col-md-6">
                <div class="card strategy-card" id="trailingCard">
                    <div class="card-header bg-success text-white">
                        <h5><i class="bi bi-graph-up-arrow"></i> Trailing Stop Strategy</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="metric-box" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                                    <h6>Total P&L</h6>
                                    <h3 id="trailingPnL">-</h3>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="metric-box" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
                                    <h6>Win Rate</h6>
                                    <h3 id="trailingWinRate">-</h3>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-3 text-center">
                                <small class="text-muted">TP Count</small>
                                <h5 id="trailingTP">-</h5>
                            </div>
                            <div class="col-3 text-center">
                                <small class="text-muted">SL Count</small>
                                <h5 id="trailingSL">-</h5>
                            </div>
                            <div class="col-3 text-center">
                                <small class="text-muted">Trail Count</small>
                                <h5 id="trailingCount">-</h5>
                            </div>
                            <div class="col-3 text-center">
                                <small class="text-muted">Avg Time</small>
                                <h5 id="trailingTime">-</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Графики сравнения -->
        <div class="row" id="chartsSection" style="display: none;">
            <!-- График накопленной прибыли -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="bi bi-graph-up"></i> Накопленная прибыль</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="cumulativePnLChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- График распределения P&L -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="bi bi-bar-chart"></i> Распределение P&L по дням</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="dailyPnLChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Детальная таблица сравнения -->
        <div class="card mt-4" id="comparisonTable" style="display: none;">
            <div class="card-header">
                <h5><i class="bi bi-table"></i> Детальное сравнение метрик</h5>
            </div>
            <div class="card-body">
                <table class="table table-hover comparison-table">
                    <thead>
                        <tr>
                            <th>Метрика</th>
                            <th>Fixed TP/SL</th>
                            <th>Trailing Stop</th>
                            <th>Разница</th>
                            <th>Победитель</th>
                        </tr>
                    </thead>
                    <tbody id="comparisonTableBody">
                        <!-- Заполняется динамически -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Рекомендации -->
        <div class="card mt-4" id="recommendations" style="display: none;">
            <div class="card-header bg-warning">
                <h5><i class="bi bi-lightbulb"></i> Рекомендации на основе анализа</h5>
            </div>
            <div class="card-body" id="recommendationsBody">
                <!-- Заполняется динамически -->
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="text-center text-white">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h4 class="mt-3">Анализируем стратегии...</h4>
            <p>Это может занять несколько минут</p>
        </div>
    </div>

    <script>
        let cumulativeChart = null;
        let dailyChart = null;

        async function runComparison() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'flex';

            const params = {
                period: document.getElementById('period').value,
                score_week: document.getElementById('scoreWeek').value,
                score_month: document.getElementById('scoreMonth').value,
                position_size: document.getElementById('positionSize').value,
                leverage: document.getElementById('leverage').value
            };

            try {
                const response = await fetch('/api/strategy/compare', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    displayResults(data.results);
                } else {
                    alert('Ошибка: ' + data.message);
                }
            } catch (error) {
                alert('Ошибка при выполнении сравнения: ' + error);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        function displayResults(results) {
            // Показываем секции
            document.getElementById('strategyCards').style.display = 'flex';
            document.getElementById('chartsSection').style.display = 'flex';
            document.getElementById('comparisonTable').style.display = 'block';
            document.getElementById('recommendations').style.display = 'block';

            // Заполняем карточки стратегий
            updateStrategyCard('fixed', results.fixed);
            updateStrategyCard('trailing', results.trailing);

            // Определяем победителя
            const winner = results.fixed.total_pnl > results.trailing.total_pnl ? 'fixed' : 'trailing';
            document.getElementById('fixedCard').classList.toggle('winner', winner === 'fixed');
            document.getElementById('trailingCard').classList.toggle('winner', winner === 'trailing');

            // Обновляем графики
            updateCharts(results);

            // Заполняем таблицу сравнения
            updateComparisonTable(results);

            // Генерируем рекомендации
            generateRecommendations(results);
        }

        function updateStrategyCard(type, data) {
            const prefix = type === 'fixed' ? 'fixed' : 'trailing';
            
            document.getElementById(prefix + 'PnL').innerHTML = formatPnL(data.total_pnl);
            document.getElementById(prefix + 'WinRate').textContent = data.win_rate.toFixed(1) + '%';
            document.getElementById(prefix + 'TP').textContent = data.tp_count;
            document.getElementById(prefix + 'SL').textContent = data.sl_count;
            document.getElementById(prefix + 'Time').textContent = data.avg_time.toFixed(1) + 'h';

            if (type === 'trailing') {
                document.getElementById('trailingCount').textContent = data.trailing_count || 0;
            }
        }

        function formatPnL(value) {
            const formatted = '$' + Math.abs(value).toFixed(2);
            if (value > 0) {
                return '<span class="positive">+' + formatted + '</span>';
            } else if (value < 0) {
                return '<span class="negative">-' + formatted.substring(1) + '</span>';
            }
            return formatted;
        }

        function updateCharts(results) {
            // Накопленная прибыль
            if (cumulativeChart) cumulativeChart.destroy();
            
            const ctx1 = document.getElementById('cumulativePnLChart').getContext('2d');
            cumulativeChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: results.dates,
                    datasets: [{
                        label: 'Fixed TP/SL',
                        data: results.fixed.cumulative_pnl,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.3
                    }, {
                        label: 'Trailing Stop',
                        data: results.trailing.cumulative_pnl,
                        borderColor: 'rgb(75, 192, 75)',
                        backgroundColor: 'rgba(75, 192, 75, 0.1)',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            }
                        }
                    }
                }
            });

            // Дневная прибыль
            if (dailyChart) dailyChart.destroy();
            
            const ctx2 = document.getElementById('dailyPnLChart').getContext('2d');
            dailyChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: results.dates,
                    datasets: [{
                        label: 'Fixed TP/SL',
                        data: results.fixed.daily_pnl,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    }, {
                        label: 'Trailing Stop',
                        data: results.trailing.daily_pnl,
                        backgroundColor: 'rgba(75, 192, 75, 0.7)',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateComparisonTable(results) {
            const metrics = [
                {name: 'Total P&L', key: 'total_pnl', format: 'currency', higher_better: true},
                {name: 'Win Rate', key: 'win_rate', format: 'percent', higher_better: true},
                {name: 'Всего сигналов', key: 'total_signals', format: 'number', higher_better: false},
                {name: 'Прибыльных', key: 'profitable_count', format: 'number', higher_better: true},
                {name: 'Убыточных', key: 'loss_count', format: 'number', higher_better: false},
                {name: 'Max Drawdown', key: 'max_drawdown', format: 'currency', higher_better: false},
                {name: 'Sharpe Ratio', key: 'sharpe_ratio', format: 'decimal', higher_better: true},
                {name: 'Profit Factor', key: 'profit_factor', format: 'decimal', higher_better: true},
            ];

            const tbody = document.getElementById('comparisonTableBody');
            tbody.innerHTML = '';

            metrics.forEach(metric => {
                const fixedValue = results.fixed[metric.key] || 0;
                const trailingValue = results.trailing[metric.key] || 0;
                const diff = trailingValue - fixedValue;
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${metric.name}</strong></td>
                    <td>${formatValue(fixedValue, metric.format)}</td>
                    <td>${formatValue(trailingValue, metric.format)}</td>
                    <td>${formatDiff(diff, metric.format, metric.higher_better)}</td>
                    <td>${getWinner(fixedValue, trailingValue, metric.higher_better)}</td>
                `;
            });
        }

        function formatValue(value, format) {
            switch(format) {
                case 'currency':
                    return '$' + value.toFixed(2);
                case 'percent':
                    return value.toFixed(1) + '%';
                case 'decimal':
                    return value.toFixed(2);
                default:
                    return value;
            }
        }

        function formatDiff(diff, format, higher_better) {
            const formatted = formatValue(Math.abs(diff), format);
            const isPositive = (diff > 0 && higher_better) || (diff < 0 && !higher_better);
            const cssClass = isPositive ? 'positive' : 'negative';
            const sign = diff > 0 ? '+' : '-';
            return `<span class="${cssClass}">${sign}${formatted}</span>`;
        }

        function getWinner(fixed, trailing, higher_better) {
            const fixedWins = higher_better ? fixed > trailing : fixed < trailing;
            if (Math.abs(fixed - trailing) < 0.01) {
                return '<span class="neutral">Равно</span>';
            }
            return fixedWins ? 
                '<span class="text-info"><i class="bi bi-trophy"></i> Fixed</span>' : 
                '<span class="text-success"><i class="bi bi-trophy"></i> Trailing</span>';
        }

        function generateRecommendations(results) {
            const recommendations = [];
            
            // Анализируем результаты
            const pnlDiff = results.trailing.total_pnl - results.fixed.total_pnl;
            const winRateDiff = results.trailing.win_rate - results.fixed.win_rate;
            
            if (pnlDiff > 0) {
                recommendations.push({
                    type: 'success',
                    text: `Trailing Stop показывает лучшую прибыльность (+$${pnlDiff.toFixed(2)} или +${((pnlDiff / results.fixed.total_pnl) * 100).toFixed(1)}%)`
                });
            } else {
                recommendations.push({
                    type: 'warning',
                    text: `Fixed TP/SL показывает лучшую прибыльность (+$${Math.abs(pnlDiff).toFixed(2)})`
                });
            }

            if (winRateDiff > 5) {
                recommendations.push({
                    type: 'success',
                    text: `Trailing Stop имеет значительно лучший Win Rate (+${winRateDiff.toFixed(1)}%)`
                });
            }

            if (results.trailing.max_drawdown < results.fixed.max_drawdown) {
                recommendations.push({
                    type: 'info',
                    text: `Trailing Stop имеет меньшую просадку, что снижает риски`
                });
            }

            // Общая рекомендация
            const overallWinner = pnlDiff > 0 ? 'Trailing Stop' : 'Fixed TP/SL';
            recommendations.push({
                type: 'primary',
                text: `<strong>Рекомендация:</strong> На основе анализа за ${results.period} дней, стратегия ${overallWinner} показывает лучшие результаты для выбранных параметров.`
            });

            // Отображаем рекомендации
            const body = document.getElementById('recommendationsBody');
            body.innerHTML = recommendations.map(rec => 
                `<div class="alert alert-${rec.type}" role="alert">
                    <i class="bi bi-info-circle"></i> ${rec.text}
                </div>`
            ).join('');
        }

        // Автозапуск при загрузке страницы
        window.onload = function() {
            // Можно добавить автоматический запуск сравнения
            // runComparison();
        };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>