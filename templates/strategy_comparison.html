{% extends "base.html" %}

{% block title %}Сравнение стратегий - Помощник Трейдера{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .strategy-card {
        transition: all 0.3s;
    }
    .strategy-card:hover {
        transform: translateY(-2px);
    }
    .strategy-card.winner {
        border-color: #10b981;
        background: linear-gradient(to bottom, #ffffff, #f0fdf4);
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Заголовок страницы -->
    <div class="bg-white overflow-hidden shadow rounded-lg mb-6">
        <div class="px-4 py-5 sm:p-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                <i class="fas fa-chart-bar text-blue-600 mr-3"></i>
                Визуальное сравнение стратегий
            </h1>
            <p class="text-gray-600">Сравнение эффективности Fixed TP/SL vs Trailing Stop на исторических данных</p>
        </div>
    </div>

    <!-- Панель параметров -->
    <div class="bg-white shadow rounded-lg mb-6">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">
                <i class="fas fa-sliders-h text-gray-600 mr-2"></i>
                Параметры сравнения
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Период анализа:</label>
                    <select id="period" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="7">7 дней</option>
                        <option value="14">14 дней</option>
                        <option value="30" selected>30 дней</option>
                        <option value="60">60 дней</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Score Week Min:</label>
                    <input type="number" id="scoreWeek" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="70" min="0" max="100">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Score Month Min:</label>
                    <input type="number" id="scoreMonth" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="70" min="0" max="100">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Position Size ($):</label>
                    <input type="number" id="positionSize" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="100" min="10">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Leverage:</label>
                    <input type="number" id="leverage" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="5" min="1" max="20">
                </div>
                
                <div class="flex items-end">
                    <button onclick="runComparison()" class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                        <i class="fas fa-play mr-2"></i>
                        Сравнить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Результаты сравнения -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6" id="strategyCards" style="display: none;">
        <!-- Fixed TP/SL Strategy Card -->
        <div class="bg-white shadow rounded-lg overflow-hidden strategy-card" id="fixedCard">
            <div class="bg-blue-600 text-white px-4 py-3">
                <h5 class="text-lg font-semibold">
                    <i class="fas fa-bullseye mr-2"></i>
                    Fixed TP/SL Strategy
                </h5>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-gradient-to-br from-purple-500 to-purple-700 text-white rounded-lg p-4 text-center">
                        <h6 class="text-sm opacity-90">Total P&L</h6>
                        <h3 class="text-2xl font-bold mt-1" id="fixedPnL">-</h3>
                    </div>
                    <div class="bg-gradient-to-br from-pink-500 to-red-500 text-white rounded-lg p-4 text-center">
                        <h6 class="text-sm opacity-90">Win Rate</h6>
                        <h3 class="text-2xl font-bold mt-1" id="fixedWinRate">-</h3>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div>
                        <p class="text-gray-500 text-sm">TP Count</p>
                        <p class="text-xl font-semibold" id="fixedTP">-</p>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">SL Count</p>
                        <p class="text-xl font-semibold" id="fixedSL">-</p>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Avg Time</p>
                        <p class="text-xl font-semibold" id="fixedTime">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trailing Stop Strategy Card -->
        <div class="bg-white shadow rounded-lg overflow-hidden strategy-card" id="trailingCard">
            <div class="bg-green-600 text-white px-4 py-3">
                <h5 class="text-lg font-semibold">
                    <i class="fas fa-chart-line mr-2"></i>
                    Trailing Stop Strategy
                </h5>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-gradient-to-br from-yellow-400 to-orange-500 text-white rounded-lg p-4 text-center">
                        <h6 class="text-sm opacity-90">Total P&L</h6>
                        <h3 class="text-2xl font-bold mt-1" id="trailingPnL">-</h3>
                    </div>
                    <div class="bg-gradient-to-br from-cyan-500 to-blue-600 text-white rounded-lg p-4 text-center">
                        <h6 class="text-sm opacity-90">Win Rate</h6>
                        <h3 class="text-2xl font-bold mt-1" id="trailingWinRate">-</h3>
                    </div>
                </div>
                <div class="grid grid-cols-4 gap-2 text-center">
                    <div>
                        <p class="text-gray-500 text-sm">TP</p>
                        <p class="text-lg font-semibold" id="trailingTP">-</p>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">SL</p>
                        <p class="text-lg font-semibold" id="trailingSL">-</p>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Trail</p>
                        <p class="text-lg font-semibold" id="trailingCount">-</p>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Time</p>
                        <p class="text-lg font-semibold" id="trailingTime">-</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Графики сравнения -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6" id="chartsSection" style="display: none;">
        <!-- График накопленной прибыли -->
        <div class="bg-white shadow rounded-lg p-6">
            <h6 class="text-lg font-medium text-gray-900 mb-4">
                <i class="fas fa-chart-line text-gray-600 mr-2"></i>
                Накопленная прибыль
            </h6>
            <div style="position: relative; height: 300px;">
                <canvas id="cumulativePnLChart"></canvas>
            </div>
        </div>

        <!-- График распределения P&L -->
        <div class="bg-white shadow rounded-lg p-6">
            <h6 class="text-lg font-medium text-gray-900 mb-4">
                <i class="fas fa-chart-bar text-gray-600 mr-2"></i>
                Распределение P&L по дням
            </h6>
            <div style="position: relative; height: 300px;">
                <canvas id="dailyPnLChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Детальная таблица сравнения -->
    <div class="bg-white shadow rounded-lg overflow-hidden mb-6" id="comparisonTable" style="display: none;">
        <div class="px-4 py-5 sm:p-6">
            <h5 class="text-lg font-medium text-gray-900 mb-4">
                <i class="fas fa-table text-gray-600 mr-2"></i>
                Детальное сравнение метрик
            </h5>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Метрика</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fixed TP/SL</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trailing Stop</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Разница</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Победитель</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="comparisonTableBody">
                        <!-- Заполняется динамически -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Рекомендации -->
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6" id="recommendations" style="display: none;">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-lightbulb text-yellow-400"></i>
            </div>
            <div class="ml-3" id="recommendationsBody">
                <!-- Заполняется динамически -->
            </div>
        </div>
    </div>
</div>

<!-- Loading overlay -->
<div class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50" id="loadingOverlay" style="display: none;">
    <div class="bg-white rounded-lg p-8 text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
        <h4 class="text-xl font-semibold mt-4">Анализируем стратегии...</h4>
        <p class="text-gray-600 mt-2">Это может занять несколько минут</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let cumulativeChart = null;
    let dailyChart = null;

    async function runComparison() {
        const loadingOverlay = document.getElementById('loadingOverlay');
        loadingOverlay.style.display = 'flex';

        const params = {
            period: document.getElementById('period').value,
            score_week: document.getElementById('scoreWeek').value,
            score_month: document.getElementById('scoreMonth').value,
            position_size: document.getElementById('positionSize').value,
            leverage: document.getElementById('leverage').value
        };

        try {
            const response = await fetch('/api/strategy/compare', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(params)
            });

            const data = await response.json();
            
            if (data.status === 'success') {
                displayResults(data.results);
            } else {
                alert('Ошибка: ' + data.message);
            }
        } catch (error) {
            alert('Ошибка при выполнении сравнения: ' + error);
        } finally {
            loadingOverlay.style.display = 'none';
        }
    }

    function displayResults(results) {
        // Показываем секции
        document.getElementById('strategyCards').style.display = 'grid';
        document.getElementById('chartsSection').style.display = 'grid';
        document.getElementById('comparisonTable').style.display = 'block';
        document.getElementById('recommendations').style.display = 'block';

        // Заполняем карточки стратегий
        updateStrategyCard('fixed', results.fixed);
        updateStrategyCard('trailing', results.trailing);

        // Определяем победителя
        const winner = results.fixed.total_pnl > results.trailing.total_pnl ? 'fixed' : 'trailing';
        document.getElementById('fixedCard').classList.toggle('winner', winner === 'fixed');
        document.getElementById('trailingCard').classList.toggle('winner', winner === 'trailing');

        // Обновляем графики
        updateCharts(results);

        // Заполняем таблицу сравнения
        updateComparisonTable(results);

        // Генерируем рекомендации
        generateRecommendations(results);
    }

    function updateStrategyCard(type, data) {
        const prefix = type === 'fixed' ? 'fixed' : 'trailing';
        
        document.getElementById(prefix + 'PnL').innerHTML = formatPnL(data.total_pnl);
        document.getElementById(prefix + 'WinRate').textContent = data.win_rate.toFixed(1) + '%';
        document.getElementById(prefix + 'TP').textContent = data.tp_count;
        document.getElementById(prefix + 'SL').textContent = data.sl_count;
        document.getElementById(prefix + 'Time').textContent = data.avg_time.toFixed(1) + 'h';

        if (type === 'trailing') {
            document.getElementById('trailingCount').textContent = data.trailing_count || 0;
        }
    }

    function formatPnL(value) {
        const formatted = '$' + Math.abs(value).toFixed(2);
        if (value > 0) {
            return '<span class="text-green-600">+' + formatted + '</span>';
        } else if (value < 0) {
            return '<span class="text-red-600">-' + formatted.substring(1) + '</span>';
        }
        return formatted;
    }

    function updateCharts(results) {
        // Накопленная прибыль
        if (cumulativeChart) cumulativeChart.destroy();
        
        const ctx1 = document.getElementById('cumulativePnLChart').getContext('2d');
        cumulativeChart = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: results.dates,
                datasets: [{
                    label: 'Fixed TP/SL',
                    data: results.fixed.cumulative_pnl,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.3
                }, {
                    label: 'Trailing Stop',
                    data: results.trailing.cumulative_pnl,
                    borderColor: 'rgb(16, 185, 129)',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toFixed(0);
                            }
                        }
                    }
                }
            }
        });

        // Дневная прибыль
        if (dailyChart) dailyChart.destroy();
        
        const ctx2 = document.getElementById('dailyPnLChart').getContext('2d');
        dailyChart = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: results.dates,
                datasets: [{
                    label: 'Fixed TP/SL',
                    data: results.fixed.daily_pnl,
                    backgroundColor: 'rgba(59, 130, 246, 0.7)',
                }, {
                    label: 'Trailing Stop',
                    data: results.trailing.daily_pnl,
                    backgroundColor: 'rgba(16, 185, 129, 0.7)',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toFixed(0);
                            }
                        }
                    }
                }
            }
        });
    }

    function updateComparisonTable(results) {
        const metrics = [
            {name: 'Total P&L', key: 'total_pnl', format: 'currency', higher_better: true},
            {name: 'Win Rate', key: 'win_rate', format: 'percent', higher_better: true},
            {name: 'Всего сигналов', key: 'total_signals', format: 'number', higher_better: false},
            {name: 'Прибыльных', key: 'profitable_count', format: 'number', higher_better: true},
            {name: 'Убыточных', key: 'loss_count', format: 'number', higher_better: false},
            {name: 'Max Drawdown', key: 'max_drawdown', format: 'currency', higher_better: false},
            {name: 'Sharpe Ratio', key: 'sharpe_ratio', format: 'decimal', higher_better: true},
            {name: 'Profit Factor', key: 'profit_factor', format: 'decimal', higher_better: true},
        ];

        const tbody = document.getElementById('comparisonTableBody');
        tbody.innerHTML = '';

        metrics.forEach(metric => {
            const fixedValue = results.fixed[metric.key] || 0;
            const trailingValue = results.trailing[metric.key] || 0;
            const diff = trailingValue - fixedValue;
            
            const row = tbody.insertRow();
            row.className = 'hover:bg-gray-50';
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${metric.name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatValue(fixedValue, metric.format)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatValue(trailingValue, metric.format)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">${formatDiff(diff, metric.format, metric.higher_better)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">${getWinner(fixedValue, trailingValue, metric.higher_better)}</td>
            `;
        });
    }

    function formatValue(value, format) {
        switch(format) {
            case 'currency':
                return '$' + value.toFixed(2);
            case 'percent':
                return value.toFixed(1) + '%';
            case 'decimal':
                return value.toFixed(2);
            default:
                return value;
        }
    }

    function formatDiff(diff, format, higher_better) {
        const formatted = formatValue(Math.abs(diff), format);
        const isPositive = (diff > 0 && higher_better) || (diff < 0 && !higher_better);
        const cssClass = isPositive ? 'text-green-600 font-semibold' : 'text-red-600 font-semibold';
        const sign = diff > 0 ? '+' : '-';
        return `<span class="${cssClass}">${sign}${formatted}</span>`;
    }

    function getWinner(fixed, trailing, higher_better) {
        const fixedWins = higher_better ? fixed > trailing : fixed < trailing;
        if (Math.abs(fixed - trailing) < 0.01) {
            return '<span class="text-gray-500">Равно</span>';
        }
        return fixedWins ? 
            '<span class="text-blue-600"><i class="fas fa-trophy"></i> Fixed</span>' : 
            '<span class="text-green-600"><i class="fas fa-trophy"></i> Trailing</span>';
    }

    function generateRecommendations(results) {
        const recommendations = [];
        
        const pnlDiff = results.trailing.total_pnl - results.fixed.total_pnl;
        const winRateDiff = results.trailing.win_rate - results.fixed.win_rate;
        
        if (pnlDiff > 0) {
            recommendations.push({
                type: 'success',
                icon: 'check-circle',
                text: `Trailing Stop показывает лучшую прибыльность (+$${pnlDiff.toFixed(2)} или +${((pnlDiff / Math.abs(results.fixed.total_pnl)) * 100).toFixed(1)}%)`
            });
        } else {
            recommendations.push({
                type: 'warning',
                icon: 'exclamation-triangle',
                text: `Fixed TP/SL показывает лучшую прибыльность (+$${Math.abs(pnlDiff).toFixed(2)})`
            });
        }

        if (winRateDiff > 5) {
            recommendations.push({
                type: 'info',
                icon: 'info-circle',
                text: `Trailing Stop имеет значительно лучший Win Rate (+${winRateDiff.toFixed(1)}%)`
            });
        }

        if (results.trailing.max_drawdown < results.fixed.max_drawdown) {
            recommendations.push({
                type: 'info',
                icon: 'shield-check',
                text: `Trailing Stop имеет меньшую просадку, что снижает риски`
            });
        }

        const overallWinner = pnlDiff > 0 ? 'Trailing Stop' : 'Fixed TP/SL';
        recommendations.push({
            type: 'primary',
            icon: 'award',
            text: `<strong>Рекомендация:</strong> На основе анализа за ${results.period} дней, стратегия ${overallWinner} показывает лучшие результаты для выбранных параметров.`
        });

        const body = document.getElementById('recommendationsBody');
        body.innerHTML = '<h3 class="text-lg font-medium text-yellow-800 mb-2">Рекомендации на основе анализа</h3>' +
            recommendations.map(rec => 
                `<div class="mb-2">
                    <i class="fas fa-${rec.icon} text-yellow-600 mr-2"></i>
                    ${rec.text}
                </div>`
            ).join('');
    }
</script>
{% endblock %}