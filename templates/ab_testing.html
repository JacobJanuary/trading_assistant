<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A/B Testing стратегий - Trading Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .test-config-card {
            border-left: 4px solid #007bff;
            margin-bottom: 20px;
        }
        .test-result-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
        }
        .confidence-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
        }
        .confidence-high { background: #d4edda; color: #155724; }
        .confidence-medium { background: #fff3cd; color: #856404; }
        .confidence-low { background: #f8d7da; color: #721c24; }
        .strategy-selector {
            border: 2px dashed #dee2e6;
            padding: 20px;
            border-radius: 10px;
            transition: all 0.3s;
        }
        .strategy-selector:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }
        .test-running {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .statistical-metric {
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 10px 0;
        }
        .progress-tracker {
            background: linear-gradient(90deg, #007bff 0%, #28a745 100%);
            height: 4px;
            border-radius: 2px;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-graph-up"></i> Trading Assistant
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/dashboard">Dashboard</a>
                <a class="nav-link" href="/scoring_analysis">Скоринг</a>
                <a class="nav-link" href="/strategy_comparison">Сравнение</a>
                <a class="nav-link active" href="/ab_testing">A/B Testing</a>
                <a class="nav-link" href="/logout">Выход</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <h2 class="mb-4">
            <i class="bi bi-shuffle"></i> A/B Тестирование стратегий
        </h2>

        <!-- Настройка A/B теста -->
        <div class="card test-config-card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-gear"></i> Настройка A/B теста</h5>
            </div>
            <div class="card-body">
                <!-- Выбор стратегий -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="strategy-selector">
                            <h6><i class="bi bi-box"></i> Стратегия A (Контроль)</h6>
                            <select id="strategyA" class="form-select mb-3">
                                <option value="fixed">Fixed TP/SL</option>
                                <option value="trailing">Trailing Stop</option>
                                <option value="custom">Custom Strategy</option>
                            </select>
                            <div id="strategyAParams">
                                <div class="row">
                                    <div class="col-6">
                                        <label>Take Profit (%):</label>
                                        <input type="number" id="tpA" class="form-control" value="4" step="0.5">
                                    </div>
                                    <div class="col-6">
                                        <label>Stop Loss (%):</label>
                                        <input type="number" id="slA" class="form-control" value="3" step="0.5">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="strategy-selector">
                            <h6><i class="bi bi-box-seam"></i> Стратегия B (Тест)</h6>
                            <select id="strategyB" class="form-select mb-3">
                                <option value="trailing" selected>Trailing Stop</option>
                                <option value="fixed">Fixed TP/SL</option>
                                <option value="custom">Custom Strategy</option>
                            </select>
                            <div id="strategyBParams">
                                <div class="row">
                                    <div class="col-4">
                                        <label>Activation (%):</label>
                                        <input type="number" id="activationB" class="form-control" value="1.5" step="0.5">
                                    </div>
                                    <div class="col-4">
                                        <label>Distance (%):</label>
                                        <input type="number" id="distanceB" class="form-control" value="1" step="0.5">
                                    </div>
                                    <div class="col-4">
                                        <label>Stop Loss (%):</label>
                                        <input type="number" id="slB" class="form-control" value="3" step="0.5">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Параметры теста -->
                <div class="row">
                    <div class="col-md-3">
                        <label><i class="bi bi-calendar-range"></i> Период тестирования:</label>
                        <select id="testPeriod" class="form-select">
                            <option value="7">7 дней</option>
                            <option value="14">14 дней</option>
                            <option value="30" selected>30 дней</option>
                            <option value="60">60 дней</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label><i class="bi bi-percent"></i> Разделение трафика:</label>
                        <div class="input-group">
                            <input type="number" id="trafficSplit" class="form-control" value="50" min="10" max="90">
                            <span class="input-group-text">% / %</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label><i class="bi bi-bullseye"></i> Минимальный размер выборки:</label>
                        <input type="number" id="sampleSize" class="form-control" value="100" min="30">
                    </div>
                    <div class="col-md-3">
                        <label><i class="bi bi-shield-check"></i> Уровень доверия:</label>
                        <select id="confidenceLevel" class="form-select">
                            <option value="0.90">90%</option>
                            <option value="0.95" selected>95%</option>
                            <option value="0.99">99%</option>
                        </select>
                    </div>
                </div>

                <!-- Метрики для отслеживания -->
                <div class="row mt-3">
                    <div class="col-12">
                        <label><i class="bi bi-bar-chart-line"></i> Основные метрики для оценки:</label>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="metricPnL" checked>
                            <label class="form-check-label" for="metricPnL">Total P&L</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="metricWinRate" checked>
                            <label class="form-check-label" for="metricWinRate">Win Rate</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="metricSharpe" checked>
                            <label class="form-check-label" for="metricSharpe">Sharpe Ratio</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="metricDrawdown">
                            <label class="form-check-label" for="metricDrawdown">Max Drawdown</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="metricTime">
                            <label class="form-check-label" for="metricTime">Avg Holding Time</label>
                        </div>
                    </div>
                </div>

                <!-- Кнопки управления -->
                <div class="row mt-4">
                    <div class="col-12 text-center">
                        <button class="btn btn-lg btn-success" onclick="startABTest()" id="startBtn">
                            <i class="bi bi-play-fill"></i> Запустить A/B тест
                        </button>
                        <button class="btn btn-lg btn-danger" onclick="stopABTest()" id="stopBtn" style="display: none;">
                            <i class="bi bi-stop-fill"></i> Остановить тест
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Прогресс выполнения -->
        <div class="card mt-4" id="progressCard" style="display: none;">
            <div class="card-body">
                <h6><i class="bi bi-hourglass-split"></i> Прогресс тестирования</h6>
                <div class="progress" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         id="testProgress" role="progressbar" style="width: 0%">0%</div>
                </div>
                <div class="row mt-3 text-center">
                    <div class="col-3">
                        <small class="text-muted">Обработано сигналов</small>
                        <h5 id="signalsProcessed">0</h5>
                    </div>
                    <div class="col-3">
                        <small class="text-muted">Стратегия A</small>
                        <h5 id="countA">0</h5>
                    </div>
                    <div class="col-3">
                        <small class="text-muted">Стратегия B</small>
                        <h5 id="countB">0</h5>
                    </div>
                    <div class="col-3">
                        <small class="text-muted">Время теста</small>
                        <h5 id="testTime">00:00</h5>
                    </div>
                </div>
            </div>
        </div>

        <!-- Результаты A/B теста -->
        <div class="row mt-4" id="resultsSection" style="display: none;">
            <!-- Статистическая значимость -->
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-calculator"></i> Статистический анализ</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="statistical-metric">
                                    <h6>P-Value</h6>
                                    <h3 id="pValue">-</h3>
                                    <small class="text-muted">Статистическая значимость</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="statistical-metric">
                                    <h6>Confidence Interval</h6>
                                    <h3 id="confidenceInterval">-</h3>
                                    <small class="text-muted">Доверительный интервал</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="statistical-metric">
                                    <h6>Statistical Power</h6>
                                    <h3 id="statPower">-</h3>
                                    <small class="text-muted">Мощность теста</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Результаты по метрикам -->
            <div class="col-md-6 mt-3">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5>Стратегия A (Контроль)</h5>
                    </div>
                    <div class="card-body">
                        <div class="test-result-card">
                            <div class="row">
                                <div class="col-6">
                                    <small>Total P&L</small>
                                    <h4 id="pnlA">-</h4>
                                </div>
                                <div class="col-6">
                                    <small>Win Rate</small>
                                    <h4 id="winRateA">-</h4>
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-4">
                                    <small>Sharpe</small>
                                    <p id="sharpeA">-</p>
                                </div>
                                <div class="col-4">
                                    <small>Signals</small>
                                    <p id="signalsA">-</p>
                                </div>
                                <div class="col-4">
                                    <small>Avg Time</small>
                                    <p id="timeA">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mt-3">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5>Стратегия B (Тест)</h5>
                    </div>
                    <div class="card-body">
                        <div class="test-result-card">
                            <div class="row">
                                <div class="col-6">
                                    <small>Total P&L</small>
                                    <h4 id="pnlB">-</h4>
                                </div>
                                <div class="col-6">
                                    <small>Win Rate</small>
                                    <h4 id="winRateB">-</h4>
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-4">
                                    <small>Sharpe</small>
                                    <p id="sharpeB">-</p>
                                </div>
                                <div class="col-4">
                                    <small>Signals</small>
                                    <p id="signalsB">-</p>
                                </div>
                                <div class="col-4">
                                    <small>Avg Time</small>
                                    <p id="timeB">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- График результатов -->
            <div class="col-md-12 mt-3">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-graph-up"></i> Динамика результатов</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="abTestChart" height="100"></canvas>
                    </div>
                </div>
            </div>

            <!-- Заключение и рекомендации -->
            <div class="col-md-12 mt-3">
                <div class="card">
                    <div class="card-header bg-warning">
                        <h5><i class="bi bi-award"></i> Заключение</h5>
                    </div>
                    <div class="card-body" id="conclusion">
                        <!-- Заполняется динамически -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let testInterval = null;
        let testStartTime = null;
        let abTestChart = null;
        let testData = {
            strategyA: [],
            strategyB: [],
            dates: []
        };

        function startABTest() {
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';
            document.getElementById('progressCard').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            
            testStartTime = Date.now();
            
            // Собираем параметры теста
            const params = {
                strategyA: {
                    type: document.getElementById('strategyA').value,
                    tp: parseFloat(document.getElementById('tpA').value),
                    sl: parseFloat(document.getElementById('slA').value)
                },
                strategyB: {
                    type: document.getElementById('strategyB').value,
                    activation: parseFloat(document.getElementById('activationB').value),
                    distance: parseFloat(document.getElementById('distanceB').value),
                    sl: parseFloat(document.getElementById('slB').value)
                },
                period: parseInt(document.getElementById('testPeriod').value),
                split: parseInt(document.getElementById('trafficSplit').value),
                sampleSize: parseInt(document.getElementById('sampleSize').value),
                confidenceLevel: parseFloat(document.getElementById('confidenceLevel').value)
            };

            // Запускаем тест через API
            runABTestAPI(params);
            
            // Обновляем прогресс каждую секунду
            testInterval = setInterval(updateTestProgress, 1000);
        }

        function stopABTest() {
            if (testInterval) {
                clearInterval(testInterval);
                testInterval = null;
            }
            
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('startBtn').style.display = 'inline-block';
            
            // Показываем результаты
            displayResults();
        }

        async function runABTestAPI(params) {
            try {
                const response = await fetch('/api/ab_test/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.slice(6));
                            handleTestUpdate(data);
                        }
                    }
                }
            } catch (error) {
                console.error('Ошибка A/B теста:', error);
                alert('Ошибка при выполнении A/B теста');
                stopABTest();
            }
        }

        function handleTestUpdate(data) {
            if (data.type === 'progress') {
                updateProgress(data);
            } else if (data.type === 'result') {
                updateResults(data);
            } else if (data.type === 'complete') {
                stopABTest();
                showConclusion(data);
            }
        }

        function updateProgress(data) {
            document.getElementById('testProgress').style.width = data.percent + '%';
            document.getElementById('testProgress').textContent = data.percent + '%';
            document.getElementById('signalsProcessed').textContent = data.totalSignals;
            document.getElementById('countA').textContent = data.countA;
            document.getElementById('countB').textContent = data.countB;
        }

        function updateTestProgress() {
            if (testStartTime) {
                const elapsed = Date.now() - testStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                document.getElementById('testTime').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        function updateResults(data) {
            // Обновляем метрики стратегии A
            document.getElementById('pnlA').textContent = '$' + data.strategyA.pnl.toFixed(2);
            document.getElementById('winRateA').textContent = data.strategyA.winRate.toFixed(1) + '%';
            document.getElementById('sharpeA').textContent = data.strategyA.sharpe.toFixed(2);
            document.getElementById('signalsA').textContent = data.strategyA.signals;
            document.getElementById('timeA').textContent = data.strategyA.avgTime.toFixed(1) + 'h';
            
            // Обновляем метрики стратегии B
            document.getElementById('pnlB').textContent = '$' + data.strategyB.pnl.toFixed(2);
            document.getElementById('winRateB').textContent = data.strategyB.winRate.toFixed(1) + '%';
            document.getElementById('sharpeB').textContent = data.strategyB.sharpe.toFixed(2);
            document.getElementById('signalsB').textContent = data.strategyB.signals;
            document.getElementById('timeB').textContent = data.strategyB.avgTime.toFixed(1) + 'h';
            
            // Обновляем статистику
            document.getElementById('pValue').textContent = data.statistics.pValue.toFixed(4);
            document.getElementById('confidenceInterval').textContent = 
                `[${data.statistics.ciLower.toFixed(2)}, ${data.statistics.ciUpper.toFixed(2)}]`;
            document.getElementById('statPower').textContent = 
                (data.statistics.power * 100).toFixed(1) + '%';
            
            // Добавляем данные для графика
            testData.strategyA.push(data.strategyA.pnl);
            testData.strategyB.push(data.strategyB.pnl);
            testData.dates.push(new Date().toLocaleTimeString());
            
            updateChart();
        }

        function displayResults() {
            document.getElementById('resultsSection').style.display = 'flex';
        }

        function updateChart() {
            const ctx = document.getElementById('abTestChart').getContext('2d');
            
            if (abTestChart) {
                abTestChart.destroy();
            }
            
            abTestChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: testData.dates,
                    datasets: [{
                        label: 'Стратегия A',
                        data: testData.strategyA,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.3
                    }, {
                        label: 'Стратегия B',
                        data: testData.strategyB,
                        borderColor: 'rgb(75, 192, 75)',
                        backgroundColor: 'rgba(75, 192, 75, 0.1)',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            }
                        }
                    }
                }
            });
        }

        function showConclusion(data) {
            const conclusionDiv = document.getElementById('conclusion');
            
            let confidenceClass = 'confidence-low';
            let confidenceText = 'Низкая достоверность';
            
            if (data.statistics.pValue < 0.05) {
                confidenceClass = 'confidence-high';
                confidenceText = 'Высокая достоверность';
            } else if (data.statistics.pValue < 0.1) {
                confidenceClass = 'confidence-medium';
                confidenceText = 'Средняя достоверность';
            }
            
            const winner = data.winner;
            const improvement = Math.abs(data.improvement).toFixed(1);
            
            conclusionDiv.innerHTML = `
                <div class="alert alert-${winner === 'B' ? 'success' : 'info'}">
                    <h5><i class="bi bi-trophy"></i> Победитель: Стратегия ${winner}</h5>
                    <p>Улучшение основной метрики: <strong>${improvement}%</strong></p>
                </div>
                
                <div class="confidence-badge ${confidenceClass}">
                    ${confidenceText} (p-value: ${data.statistics.pValue.toFixed(4)})
                </div>
                
                <div class="mt-3">
                    <h6>Рекомендации:</h6>
                    <ul>
                        ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
                
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="exportResults()">
                        <i class="bi bi-download"></i> Экспорт результатов
                    </button>
                    <button class="btn btn-success" onclick="applyWinnerStrategy()">
                        <i class="bi bi-check-circle"></i> Применить победившую стратегию
                    </button>
                </div>
            `;
        }

        function exportResults() {
            // Экспорт результатов в CSV или PDF
            alert('Функция экспорта будет реализована');
        }

        function applyWinnerStrategy() {
            // Применение победившей стратегии
            if (confirm('Применить победившую стратегию ко всем будущим сигналам?')) {
                // Отправка запроса на сервер для применения стратегии
                alert('Стратегия применена');
            }
        }

        // Обработчики изменения типа стратегии
        document.getElementById('strategyA').addEventListener('change', function() {
            updateStrategyParams('A', this.value);
        });

        document.getElementById('strategyB').addEventListener('change', function() {
            updateStrategyParams('B', this.value);
        });

        function updateStrategyParams(strategy, type) {
            const paramsDiv = document.getElementById(`strategy${strategy}Params`);
            
            if (type === 'fixed') {
                paramsDiv.innerHTML = `
                    <div class="row">
                        <div class="col-6">
                            <label>Take Profit (%):</label>
                            <input type="number" id="tp${strategy}" class="form-control" value="4" step="0.5">
                        </div>
                        <div class="col-6">
                            <label>Stop Loss (%):</label>
                            <input type="number" id="sl${strategy}" class="form-control" value="3" step="0.5">
                        </div>
                    </div>
                `;
            } else if (type === 'trailing') {
                paramsDiv.innerHTML = `
                    <div class="row">
                        <div class="col-4">
                            <label>Activation (%):</label>
                            <input type="number" id="activation${strategy}" class="form-control" value="1.5" step="0.5">
                        </div>
                        <div class="col-4">
                            <label>Distance (%):</label>
                            <input type="number" id="distance${strategy}" class="form-control" value="1" step="0.5">
                        </div>
                        <div class="col-4">
                            <label>Stop Loss (%):</label>
                            <input type="number" id="sl${strategy}" class="form-control" value="3" step="0.5">
                        </div>
                    </div>
                `;
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>