{% extends "base.html" %}

{% block title %}A/B Тестирование - Помощник Трейдера{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .strategy-selector {
        transition: all 0.3s;
    }
    .strategy-selector:hover {
        background-color: #f9fafb;
        border-color: #3b82f6;
    }
    .test-running {
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
    .progress-tracker {
        transition: width 0.3s;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Заголовок страницы -->
    <div class="bg-white overflow-hidden shadow rounded-lg mb-6">
        <div class="px-4 py-5 sm:p-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                <i class="fas fa-flask text-blue-600 mr-3"></i>
                A/B Тестирование стратегий
            </h1>
            <p class="text-gray-600">Статистическое сравнение эффективности торговых стратегий с контролем случайности</p>
        </div>
    </div>

    <!-- Настройка A/B теста -->
    <div class="bg-white shadow rounded-lg mb-6">
        <div class="border-l-4 border-blue-600">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">
                    <i class="fas fa-cog text-gray-600 mr-2"></i>
                    Настройка A/B теста
                </h3>
                
                <!-- Выбор стратегий -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Стратегия A -->
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 strategy-selector">
                        <h6 class="text-md font-semibold text-gray-900 mb-3">
                            <i class="fas fa-cube text-blue-500 mr-2"></i>
                            Стратегия A (Контроль)
                        </h6>
                        <select id="strategyA" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 mb-4">
                            <option value="fixed">Fixed TP/SL</option>
                            <option value="trailing">Trailing Stop</option>
                            <option value="custom">Custom Strategy</option>
                        </select>
                        <div id="strategyAParams">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Take Profit (%):</label>
                                    <input type="number" id="tpA" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="4" step="0.5">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Stop Loss (%):</label>
                                    <input type="number" id="slA" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="3" step="0.5">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Стратегия B -->
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 strategy-selector">
                        <h6 class="text-md font-semibold text-gray-900 mb-3">
                            <i class="fas fa-cube text-green-500 mr-2"></i>
                            Стратегия B (Тест)
                        </h6>
                        <select id="strategyB" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 mb-4">
                            <option value="trailing" selected>Trailing Stop</option>
                            <option value="fixed">Fixed TP/SL</option>
                            <option value="custom">Custom Strategy</option>
                        </select>
                        <div id="strategyBParams">
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Activation (%):</label>
                                    <input type="number" id="activationB" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="1.5" step="0.5">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Distance (%):</label>
                                    <input type="number" id="distanceB" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="1" step="0.5">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Stop Loss (%):</label>
                                    <input type="number" id="slB" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="3" step="0.5">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Параметры теста -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-calendar-alt text-gray-500 mr-1"></i>
                            Период тестирования:
                        </label>
                        <select id="testPeriod" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="7">7 дней</option>
                            <option value="14">14 дней</option>
                            <option value="30" selected>30 дней</option>
                            <option value="60">60 дней</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-percentage text-gray-500 mr-1"></i>
                            Разделение трафика:
                        </label>
                        <div class="flex">
                            <input type="number" id="trafficSplit" class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="50" min="10" max="90">
                            <span class="px-3 py-2 bg-gray-50 border border-l-0 border-gray-300 rounded-r-md text-gray-500">% / %</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-bullseye text-gray-500 mr-1"></i>
                            Мин. размер выборки:
                        </label>
                        <input type="number" id="sampleSize" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="100" min="30">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-shield-alt text-gray-500 mr-1"></i>
                            Уровень доверия:
                        </label>
                        <select id="confidenceLevel" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="0.90">90%</option>
                            <option value="0.95" selected>95%</option>
                            <option value="0.99">99%</option>
                        </select>
                    </div>
                </div>

                <!-- Метрики для отслеживания -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-chart-line text-gray-500 mr-1"></i>
                        Основные метрики для оценки:
                    </label>
                    <div class="flex flex-wrap gap-4">
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="metricPnL" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                            <span class="ml-2 text-sm text-gray-700">Total P&L</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="metricWinRate" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                            <span class="ml-2 text-sm text-gray-700">Win Rate</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="metricSharpe" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                            <span class="ml-2 text-sm text-gray-700">Sharpe Ratio</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="metricDrawdown" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-700">Max Drawdown</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="metricTime" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-700">Avg Holding Time</span>
                        </label>
                    </div>
                </div>

                <!-- Кнопки управления -->
                <div class="text-center">
                    <button onclick="startABTest()" id="startBtn" class="bg-green-600 text-white px-8 py-3 rounded-md hover:bg-green-700 transition-colors text-lg font-semibold">
                        <i class="fas fa-play mr-2"></i>
                        Запустить A/B тест
                    </button>
                    <button onclick="stopABTest()" id="stopBtn" class="bg-red-600 text-white px-8 py-3 rounded-md hover:bg-red-700 transition-colors text-lg font-semibold" style="display: none;">
                        <i class="fas fa-stop mr-2"></i>
                        Остановить тест
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Прогресс выполнения -->
    <div class="bg-white shadow rounded-lg mb-6" id="progressCard" style="display: none;">
        <div class="px-4 py-5 sm:p-6">
            <h6 class="text-lg font-medium text-gray-900 mb-4">
                <i class="fas fa-hourglass-half text-gray-600 mr-2"></i>
                Прогресс тестирования
            </h6>
            <div class="relative pt-1">
                <div class="overflow-hidden h-6 mb-4 text-xs flex rounded bg-gray-200">
                    <div id="testProgress" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-600 transition-all duration-300" style="width: 0%">
                        <span class="font-semibold">0%</span>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-4 gap-4 text-center">
                <div>
                    <p class="text-sm text-gray-500">Обработано сигналов</p>
                    <p class="text-2xl font-bold text-gray-900" id="signalsProcessed">0</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Стратегия A</p>
                    <p class="text-2xl font-bold text-blue-600" id="countA">0</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Стратегия B</p>
                    <p class="text-2xl font-bold text-green-600" id="countB">0</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Время теста</p>
                    <p class="text-2xl font-bold text-gray-900" id="testTime">00:00</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Результаты A/B теста -->
    <div id="resultsSection" style="display: none;">
        <!-- Статистическая значимость -->
        <div class="bg-white shadow rounded-lg mb-6">
            <div class="px-4 py-5 sm:p-6">
                <h5 class="text-lg font-medium text-gray-900 mb-4">
                    <i class="fas fa-calculator text-gray-600 mr-2"></i>
                    Статистический анализ
                </h5>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gray-50 rounded-lg p-4 text-center">
                        <h6 class="text-sm font-medium text-gray-500 uppercase tracking-wider">P-Value</h6>
                        <h3 class="text-3xl font-bold text-gray-900 mt-2" id="pValue">-</h3>
                        <p class="text-xs text-gray-500 mt-1">Статистическая значимость</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 text-center">
                        <h6 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Confidence Interval</h6>
                        <h3 class="text-2xl font-bold text-gray-900 mt-2" id="confidenceInterval">-</h3>
                        <p class="text-xs text-gray-500 mt-1">Доверительный интервал</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 text-center">
                        <h6 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Statistical Power</h6>
                        <h3 class="text-3xl font-bold text-gray-900 mt-2" id="statPower">-</h3>
                        <p class="text-xs text-gray-500 mt-1">Мощность теста</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Результаты по метрикам -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Стратегия A -->
            <div class="bg-white shadow rounded-lg overflow-hidden">
                <div class="bg-blue-600 text-white px-4 py-3">
                    <h5 class="text-lg font-semibold">Стратегия A (Контроль)</h5>
                </div>
                <div class="p-6">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <p class="text-sm text-gray-500">Total P&L</p>
                                <p class="text-2xl font-bold text-gray-900" id="pnlA">-</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Win Rate</p>
                                <p class="text-2xl font-bold text-gray-900" id="winRateA">-</p>
                            </div>
                        </div>
                        <hr class="my-3">
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div>
                                <p class="text-xs text-gray-500">Sharpe</p>
                                <p class="text-sm font-semibold" id="sharpeA">-</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Signals</p>
                                <p class="text-sm font-semibold" id="signalsA">-</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Avg Time</p>
                                <p class="text-sm font-semibold" id="timeA">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Стратегия B -->
            <div class="bg-white shadow rounded-lg overflow-hidden">
                <div class="bg-green-600 text-white px-4 py-3">
                    <h5 class="text-lg font-semibold">Стратегия B (Тест)</h5>
                </div>
                <div class="p-6">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <p class="text-sm text-gray-500">Total P&L</p>
                                <p class="text-2xl font-bold text-gray-900" id="pnlB">-</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Win Rate</p>
                                <p class="text-2xl font-bold text-gray-900" id="winRateB">-</p>
                            </div>
                        </div>
                        <hr class="my-3">
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div>
                                <p class="text-xs text-gray-500">Sharpe</p>
                                <p class="text-sm font-semibold" id="sharpeB">-</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Signals</p>
                                <p class="text-sm font-semibold" id="signalsB">-</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Avg Time</p>
                                <p class="text-sm font-semibold" id="timeB">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- График результатов -->
        <div class="bg-white shadow rounded-lg p-6 mb-6">
            <h5 class="text-lg font-medium text-gray-900 mb-4">
                <i class="fas fa-chart-line text-gray-600 mr-2"></i>
                Динамика результатов
            </h5>
            <div style="position: relative; height: 300px;">
                <canvas id="abTestChart"></canvas>
            </div>
        </div>

        <!-- Заключение и рекомендации -->
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-award text-yellow-400"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-lg font-medium text-yellow-800 mb-2">Заключение</h3>
                    <div id="conclusion">
                        <!-- Заполняется динамически -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading overlay -->
<div class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50" id="loadingOverlay" style="display: none;">
    <div class="bg-white rounded-lg p-8 text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
        <h4 class="text-xl font-semibold mt-4">Выполняется A/B тест...</h4>
        <p class="text-gray-600 mt-2">Анализируем стратегии</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let testInterval = null;
    let testStartTime = null;
    let abTestChart = null;
    let testData = {
        strategyA: [],
        strategyB: [],
        dates: []
    };

    function startABTest() {
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'inline-block';
        document.getElementById('progressCard').style.display = 'block';
        document.getElementById('resultsSection').style.display = 'none';
        
        testStartTime = Date.now();
        
        // Собираем параметры теста
        const params = {
            strategyA: {
                type: document.getElementById('strategyA').value,
                tp: parseFloat(document.getElementById('tpA').value),
                sl: parseFloat(document.getElementById('slA').value)
            },
            strategyB: {
                type: document.getElementById('strategyB').value,
                activation: parseFloat(document.getElementById('activationB').value),
                distance: parseFloat(document.getElementById('distanceB').value),
                sl: parseFloat(document.getElementById('slB').value)
            },
            period: parseInt(document.getElementById('testPeriod').value),
            split: parseInt(document.getElementById('trafficSplit').value),
            sampleSize: parseInt(document.getElementById('sampleSize').value),
            confidenceLevel: parseFloat(document.getElementById('confidenceLevel').value)
        };

        // Запускаем тест через API
        runABTestAPI(params);
        
        // Обновляем прогресс каждую секунду
        testInterval = setInterval(updateTestProgress, 1000);
    }

    function stopABTest() {
        if (testInterval) {
            clearInterval(testInterval);
            testInterval = null;
        }
        
        document.getElementById('stopBtn').style.display = 'none';
        document.getElementById('startBtn').style.display = 'inline-block';
        
        // Показываем результаты
        displayResults();
    }

    async function runABTestAPI(params) {
        try {
            const response = await fetch('/api/ab_test/run', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(params)
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = JSON.parse(line.slice(6));
                        handleTestUpdate(data);
                    }
                }
            }
        } catch (error) {
            console.error('Ошибка A/B теста:', error);
            alert('Ошибка при выполнении A/B теста');
            stopABTest();
        }
    }

    function handleTestUpdate(data) {
        if (data.type === 'progress') {
            updateProgress(data);
        } else if (data.type === 'result') {
            updateResults(data);
        } else if (data.type === 'complete') {
            stopABTest();
            showConclusion(data);
        }
    }

    function updateProgress(data) {
        const progressBar = document.getElementById('testProgress');
        progressBar.style.width = data.percent + '%';
        progressBar.innerHTML = `<span class="font-semibold">${data.percent}%</span>`;
        document.getElementById('signalsProcessed').textContent = data.totalSignals;
        document.getElementById('countA').textContent = data.countA;
        document.getElementById('countB').textContent = data.countB;
    }

    function updateTestProgress() {
        if (testStartTime) {
            const elapsed = Date.now() - testStartTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            document.getElementById('testTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
    }

    function updateResults(data) {
        // Обновляем метрики стратегии A
        document.getElementById('pnlA').textContent = '$' + data.strategyA.pnl.toFixed(2);
        document.getElementById('winRateA').textContent = data.strategyA.winRate.toFixed(1) + '%';
        document.getElementById('sharpeA').textContent = data.strategyA.sharpe.toFixed(2);
        document.getElementById('signalsA').textContent = data.strategyA.signals;
        document.getElementById('timeA').textContent = data.strategyA.avgTime.toFixed(1) + 'h';
        
        // Обновляем метрики стратегии B
        document.getElementById('pnlB').textContent = '$' + data.strategyB.pnl.toFixed(2);
        document.getElementById('winRateB').textContent = data.strategyB.winRate.toFixed(1) + '%';
        document.getElementById('sharpeB').textContent = data.strategyB.sharpe.toFixed(2);
        document.getElementById('signalsB').textContent = data.strategyB.signals;
        document.getElementById('timeB').textContent = data.strategyB.avgTime.toFixed(1) + 'h';
        
        // Обновляем статистику
        document.getElementById('pValue').textContent = data.statistics.pValue.toFixed(4);
        document.getElementById('confidenceInterval').textContent = 
            `[${data.statistics.ciLower.toFixed(2)}, ${data.statistics.ciUpper.toFixed(2)}]`;
        document.getElementById('statPower').textContent = 
            (data.statistics.power * 100).toFixed(1) + '%';
        
        // Добавляем данные для графика
        testData.strategyA.push(data.strategyA.pnl);
        testData.strategyB.push(data.strategyB.pnl);
        testData.dates.push(new Date().toLocaleTimeString());
        
        updateChart();
    }

    function displayResults() {
        document.getElementById('resultsSection').style.display = 'block';
    }

    function updateChart() {
        const ctx = document.getElementById('abTestChart').getContext('2d');
        
        if (abTestChart) {
            abTestChart.destroy();
        }
        
        abTestChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: testData.dates,
                datasets: [{
                    label: 'Стратегия A',
                    data: testData.strategyA,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.3
                }, {
                    label: 'Стратегия B',
                    data: testData.strategyB,
                    borderColor: 'rgb(16, 185, 129)',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toFixed(0);
                            }
                        }
                    }
                }
            }
        });
    }

    function showConclusion(data) {
        const conclusionDiv = document.getElementById('conclusion');
        
        let confidenceClass = 'bg-red-100 text-red-800';
        let confidenceText = 'Низкая достоверность';
        
        if (data.statistics.pValue < 0.05) {
            confidenceClass = 'bg-green-100 text-green-800';
            confidenceText = 'Высокая достоверность';
        } else if (data.statistics.pValue < 0.1) {
            confidenceClass = 'bg-yellow-100 text-yellow-800';
            confidenceText = 'Средняя достоверность';
        }
        
        const winner = data.winner;
        const improvement = Math.abs(data.improvement).toFixed(1);
        
        conclusionDiv.innerHTML = `
            <div class="bg-white rounded-lg p-4 mb-4 border ${winner === 'B' ? 'border-green-500' : 'border-blue-500'}">
                <h5 class="text-lg font-semibold mb-2">
                    <i class="fas fa-trophy ${winner === 'B' ? 'text-green-500' : 'text-blue-500'}"></i>
                    Победитель: Стратегия ${winner}
                </h5>
                <p class="text-gray-700">Улучшение основной метрики: <strong>${improvement}%</strong></p>
            </div>
            
            <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${confidenceClass} mb-4">
                ${confidenceText} (p-value: ${data.statistics.pValue.toFixed(4)})
            </div>
            
            <div class="mt-3">
                <h6 class="font-semibold text-gray-900 mb-2">Рекомендации:</h6>
                <ul class="list-disc list-inside space-y-1 text-gray-700">
                    ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
            </div>
            
            <div class="mt-4 flex gap-2">
                <button onclick="exportResults()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                    <i class="fas fa-download mr-2"></i>
                    Экспорт результатов
                </button>
                <button onclick="applyWinnerStrategy()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                    <i class="fas fa-check-circle mr-2"></i>
                    Применить победившую стратегию
                </button>
            </div>
        `;
    }

    function exportResults() {
        // Экспорт результатов в CSV или PDF
        alert('Функция экспорта будет реализована');
    }

    function applyWinnerStrategy() {
        // Применение победившей стратегии
        if (confirm('Применить победившую стратегию ко всем будущим сигналам?')) {
            // Отправка запроса на сервер для применения стратегии
            alert('Стратегия применена');
        }
    }

    // Обработчики изменения типа стратегии
    document.getElementById('strategyA').addEventListener('change', function() {
        updateStrategyParams('A', this.value);
    });

    document.getElementById('strategyB').addEventListener('change', function() {
        updateStrategyParams('B', this.value);
    });

    function updateStrategyParams(strategy, type) {
        const paramsDiv = document.getElementById(`strategy${strategy}Params`);
        
        if (type === 'fixed') {
            paramsDiv.innerHTML = `
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Take Profit (%):</label>
                        <input type="number" id="tp${strategy}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="4" step="0.5">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Stop Loss (%):</label>
                        <input type="number" id="sl${strategy}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="3" step="0.5">
                    </div>
                </div>
            `;
        } else if (type === 'trailing') {
            paramsDiv.innerHTML = `
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Activation (%):</label>
                        <input type="number" id="activation${strategy}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="1.5" step="0.5">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Distance (%):</label>
                        <input type="number" id="distance${strategy}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="1" step="0.5">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Stop Loss (%):</label>
                        <input type="number" id="sl${strategy}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="3" step="0.5">
                    </div>
                </div>
            `;
        }
    }
</script>
{% endblock %}